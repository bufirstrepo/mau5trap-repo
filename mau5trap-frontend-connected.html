<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mau5trap Intelligence Platform</title>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <style>
        :root {
            /* Night Mode (Default) - Neon Green Theme */
            --primary: #00FF5F;
            /* Mau5trap Neon Green */
            --primary-dim: rgba(0, 255, 95, 0.1);
            --bg-color: #0A0A0A;
            /* Charcoal Black */
            --text-color: #F5F5F5;
            /* Soft White */
            --text-secondary: #B5B5B5;
            /* Muted Gray */
            --panel-bg: rgba(20, 20, 20, 0.75);
            /* Dark Glass */
            --input-bg: rgba(0, 0, 0, 0.3);
            /* Dark Input */
            --border: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.1);
            --decoration-gradient: linear-gradient(to bottom, rgba(0, 255, 95, 0.10), rgba(0, 255, 95, 0));
            --hover-overlay: rgba(255, 255, 255, 0.08);
            --card-overlay: rgba(255, 255, 255, 0.04);
            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* Day Mode - Red Theme */
        body.day-mode {
            --primary: #FF0000;
            /* Mau5head Red */
            --primary-dim: rgba(255, 0, 0, 0.08);
            /* Red-tinted wash */
            --bg-color: #FFFFFF;
            /* Pure White */
            --text-color: #000000;
            /* Deep Black */
            --text-secondary: #333333;
            /* Charcoal Gray */
            --panel-bg: rgba(255, 255, 255, 0.75);
            /* Light Glass */
            --input-bg: rgba(0, 0, 0, 0.05);
            /* Light Grey Input */
            --border: rgba(0, 0, 0, 0.1);
            --glass-border: rgba(0, 0, 0, 0.1);
            --decoration-gradient: linear-gradient(to bottom, rgba(255, 0, 0, 0.08), rgba(255, 0, 0, 0));
            --hover-overlay: rgba(255, 0, 0, 0.12);
            /* Subtle Red Hover */
            --card-overlay: rgba(0, 0, 0, 0.05);
            /* Darken slightly on white */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            outline: none;
        }

        body {
            background-color: var(--bg-color);
            /* Global Decoration Gradient */
            background-image: var(--decoration-gradient);
            background-attachment: fixed;
            /* Ensures gradient covers full scroll */
            background-size: 100% 100vh;
            /* Full viewport coverage */
            background-repeat: no-repeat;
            color: var(--text-color);
            font-family: var(--font-main);
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Utilities */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: var(--glass);
            -webkit-backdrop-filter: var(--glass);
            border: 1px solid var(--border);
            border-radius: 16px;
        }

        .text-gradient {
            background: linear-gradient(135deg, #fff 0%, #ccc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .text-neon {
            color: var(--primary);
            text-shadow: var(--primary-glow);
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(0, 255, 0, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(0, 255, 0, 0);
            }
        }

        @keyframes scanline {
            0% {
                transform: translateY(-100%);
            }

            100% {
                transform: translateY(100%);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .mau5-head {
            width: 80px;
            height: 80px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            position: relative;
            animation: pulse 2s infinite;
        }

        .mau5-head::before,
        .mau5-head::after {
            content: '';
            position: absolute;
            top: -30px;
            width: 50px;
            height: 50px;
            border: 4px solid var(--primary);
            border-radius: 50%;
            background: var(--bg-dark);
        }

        .mau5-head::before {
            left: -25px;
        }

        .mau5-head::after {
            right: -25px;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = 'http://localhost:3000';
        // API_KEY removed: Using JWT Auth

        // --- COMPONENTS ---

        const StatCard = ({ label, value, sub, delay }) => (
            <div
                className="glass-panel"
                style={{
                    padding: '24px',
                    position: 'relative',
                    overflow: 'hidden'
                }}
            >
                <div style={{ position: 'absolute', top: 0, left: 0, width: '2px', height: '100%', background: 'var(--primary)', opacity: 0.5 }}></div>
                <div className="text-muted" style={{ fontSize: '13px', textTransform: 'uppercase', letterSpacing: '1px', marginBottom: '8px' }}>
                    {label}
                </div>
                <div className="mono" style={{ fontSize: '32px', fontWeight: 'bold', color: 'var(--text-color)', marginBottom: '4px' }}>
                    {value}
                </div>
                {sub && <div style={{ fontSize: '12px', color: 'var(--primary)' }}>{sub}</div>}
            </div>
        );

        const ArtistRow = ({ artist, index, user, authToken, onUpdate, onSelect }) => {
            const handleArchive = async (e) => {
                e.stopPropagation();
                if (!confirm(`Archive ${artist.name}?`)) return;
                try {
                    await fetch(`${API_BASE}/v3/artists/${artist.id}/archive`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (onUpdate) onUpdate();
                } catch (e) { alert('Archive failed'); }
            };

            return (
                <tr
                    className=""
                    style={{
                        borderBottom: '1px solid rgba(255,255,255,0.05)',
                        transition: 'background 0.2s'
                    }}
                    onMouseEnter={e => e.currentTarget.style.background = 'rgba(255,255,255,0.03)'}
                    onMouseLeave={e => e.currentTarget.style.background = 'transparent'}
                >
                    <td style={{ padding: '16px', color: 'var(--text-color)', fontWeight: '500' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                            <div style={{
                                width: '32px', height: '32px', borderRadius: '50%',
                                background: `linear-gradient(45deg, #333, #111)`,
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                fontSize: '12px', color: 'var(--text-secondary)'
                            }}>
                                {index + 1}
                            </div>
                            {artist.displayName || artist.name}
                        </div>
                    </td>
                    <td style={{ padding: '16px' }}>
                        <span style={{
                            padding: '4px 12px', borderRadius: '20px',
                            background: artist.tier === 'flagship' ? 'var(--primary-dim)' : 'var(--card-overlay)',
                            color: artist.tier === 'flagship' ? 'var(--primary)' : 'var(--text-secondary)',
                            fontSize: '11px', fontWeight: '600', textTransform: 'uppercase', letterSpacing: '0.5px',
                            border: artist.tier === 'flagship' ? '1px solid var(--primary)' : '1px solid var(--border)'
                        }}>
                            {artist.tier}
                        </span>
                    </td>
                    <td style={{ padding: '16px', textAlign: 'right', fontFamily: 'JetBrains Mono', color: 'var(--text-secondary)' }}>
                        {(artist.monthlyListeners / 1000000).toFixed(1)}M
                    </td>
                    <td style={{ padding: '16px', textAlign: 'right', fontFamily: 'JetBrains Mono', color: 'var(--text-color)' }}>
                        ${(artist.totalRevenue / 1000).toFixed(0)}k
                    </td>
                    <td style={{ padding: '16px', textAlign: 'right' }}>
                        <span style={{ color: 'var(--primary)', fontWeight: 'bold' }}>{artist.roi}x</span>
                    </td>
                    <td style={{ padding: '16px', textAlign: 'right', display: 'flex', justifyContent: 'flex-end', gap: '8px', alignItems: 'center' }}>
                        <button onClick={() => onSelect(artist)} style={{ background: 'var(--primary-dim)', color: 'var(--primary)', border: 'none', padding: '6px 12px', borderRadius: '4px', cursor: 'pointer', fontSize: '10px', fontWeight: 'bold' }}>
                            VIEW
                        </button>
                        {user && user.role === 'admin' && (
                            <button onClick={handleArchive} style={{ background: 'rgba(255, 50, 50, 0.1)', border: '1px solid rgba(255, 50, 50, 0.3)', color: '#ff4444', cursor: 'pointer', fontSize: '10px', padding: '6px 12px', borderRadius: '4px', fontWeight: 'bold' }}>
                                ARCHIVE
                            </button>
                        )}
                    </td>
                </tr>
            );
        };

        const IntelligenceGraph = ({ artists, isDayMode }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                let width = canvas.width = canvas.parentElement.offsetWidth;
                let height = canvas.height = 600;

                // Nodes
                const TIER_COLORS = {
                    flagship: '#00FF00', // Neon Green
                    core: '#00E5FF',     // Cyan
                    developing: '#D500F9', // Purple
                    default: '#FFFFFF'
                };

                const nodes = artists.filter(a => a.tier !== 'archived' && a.status !== 'archived').map(a => ({
                    id: a.id,
                    x: Math.random() * width,
                    y: Math.random() * height,
                    vx: (Math.random() - 0.5) * 2,
                    vy: (Math.random() - 0.5) * 2,
                    r: Math.max(5, Math.log(a.monthlyListeners) / 1.5),
                    color: TIER_COLORS[a.tier] || TIER_COLORS.default,
                    name: a.name
                }));

                // Links
                const links = [];
                artists.forEach(a => {
                    if (a.collaborations) {
                        a.collaborations.forEach(targetId => {
                            const target = nodes.find(n => n.id === targetId);
                            if (target) {
                                links.push({ source: nodes.find(n => n.id === a.id), target });
                            }
                        });
                    }
                });

                let animationFrameId;

                const render = () => {
                    ctx.clearRect(0, 0, width, height);

                    // Update positions
                    nodes.forEach(node => {
                        node.x += node.vx;
                        node.y += node.vy;

                        if (node.x < 0 || node.x > width) node.vx *= -1;
                        if (node.y < 0 || node.y > height) node.vy *= -1;
                    });

                    // Draw connections
                    ctx.strokeStyle = isDayMode ? 'rgba(255, 0, 0, 0.2)' : 'rgba(0, 255, 0, 0.2)';
                    ctx.lineWidth = 1;
                    links.forEach(link => {
                        ctx.beginPath();
                        ctx.moveTo(link.source.x, link.source.y);
                        ctx.lineTo(link.target.x, link.target.y);
                        ctx.stroke();
                    });

                    // Draw nodes
                    nodes.forEach(node => {
                        ctx.fillStyle = node.color;
                        ctx.beginPath();
                        ctx.arc(node.x, node.y, node.r, 0, Math.PI * 2);
                        ctx.fill();

                        ctx.fillStyle = isDayMode ? '#000' : '#fff';
                        ctx.font = '10px Inter';
                        ctx.fillText(node.name, node.x + 12, node.y + 4);
                    });

                    animationFrameId = requestAnimationFrame(render);
                };

                render();

                return () => cancelAnimationFrame(animationFrameId);
            }, [artists, isDayMode]);

            return (
                <div style={{ width: '100%', height: '600px', background: 'var(--input-bg)', borderRadius: '16px', overflow: 'hidden', position: 'relative' }}>
                    <canvas ref={canvasRef} style={{ display: 'block' }} />

                    {/* Color Legend */}
                    <div style={{ position: 'absolute', top: '20px', left: '20px', background: 'rgba(0,0,0,0.6)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(255,255,255,0.1)' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                            <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#00FF00' }}></div>
                            <span style={{ fontSize: '10px', fontWeight: 'bold' }}>FLAGSHIP</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
                            <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#00E5FF' }}></div>
                            <span style={{ fontSize: '10px', fontWeight: 'bold' }}>CORE</span>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <div style={{ width: '10px', height: '10px', borderRadius: '50%', background: '#D500F9' }}></div>
                            <span style={{ fontSize: '10px', fontWeight: 'bold' }}>DEVELOPING</span>
                        </div>
                    </div>
                </div>
            );
        };

        const DemoRow = ({ demo, authToken, onVoteChange, onPlay, isPlaying, user }) => {
            const [stats, setStats] = useState({ stars: 0, artistVotes: 0, totalVotes: 0, ratio: 0 }); // Initial state with all stats
            const [statsVisible, setStatsVisible] = useState(false);
            const [hasVoted, setHasVoted] = useState(demo.hasVoted || false);
            const [loadingStats, setLoadingStats] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false);

            const title = demo.track || 'Untitled Demo';
            const artist = demo.artist || 'Unknown Artist';

            // Sync local state with prop updates (Important for re-renders after parent fetch)
            useEffect(() => {
                setHasVoted(demo.hasVoted);
            }, [demo.hasVoted]);

            const handleDelete = async (e) => {
                if (e) e.stopPropagation();
                try {
                    await fetch(`${API_BASE}/v3/anr/submissions/${demo.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${authToken}` } });
                    onVoteChange();
                } catch (e) { alert('Delete failed'); }
            };

            const toggleStats = async (e) => {
                if (e) e.stopPropagation();

                if (!statsVisible) {
                    // Reveal: Fetch full tally (Stars + Counts)
                    setLoadingStats(true);
                    try {
                        const res = await fetch(`${API_BASE}/v3/anr/demos/${demo.id}/rating?includeTally=true`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        const data = await res.json();
                        setStats(data);
                    } catch (e) { console.error("Tally fetch err", e); }
                    setLoadingStats(false);
                }
                setStatsVisible(!statsVisible);
            };

            const handleVote = async (action, e) => {
                if (e) e.stopPropagation();

                const prevVoted = hasVoted;
                setHasVoted(action === 'add'); // Optimistic

                try {
                    const res = await fetch(`${API_BASE}/v3/anr/vote/${demo.id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ action })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        setHasVoted(data.hasVoted); // Confirm state

                        // If stats visible, update them seamlessly
                        if (statsVisible) {
                            setStats(prev => ({
                                ...prev,
                                stars: data.demo.stars,
                                artistVotes: data.demo.artistVotes,
                                totalVotes: data.demo.totalVotes,
                                ratio: data.demo.ratio
                            }));
                        }
                        onVoteChange(); // Notify parent
                    } else {
                        throw new Error('Vote failed');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Vote failed: ' + err.message);
                    setHasVoted(prevVoted); // Rollback
                }
            };

            return (
                <div style={{
                    display: 'flex', justifyContent: 'space-between', alignItems: 'center',
                    padding: '16px', background: 'var(--card-overlay)', borderRadius: '8px',
                    borderLeft: isPlaying ? '4px solid var(--primary)' : `4px solid ${demo.status === 'high-priority' ? '#ff4444' : 'transparent'}`,
                    marginBottom: '12px',
                    position: 'relative'
                }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px', flex: 1 }}>
                        <button onClick={(e) => { e.stopPropagation(); onPlay(demo); }} style={{
                            width: '32px', height: '32px', borderRadius: '50%',
                            background: isPlaying ? 'var(--primary)' : 'rgba(255,255,255,0.1)',
                            border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center',
                            transition: 'all 0.2s'
                        }}>
                            <i className={isPlaying ? "ri-pause-line" : "ri-play-fill"} style={{ color: isPlaying ? 'var(--text-color)' : 'var(--text-color)', fontSize: '16px' }}></i>
                        </button>

                        <div style={{ flex: 1 }}>
                            <div style={{ fontWeight: 'bold', fontSize: '14px', color: isPlaying ? 'var(--primary)' : '#fff' }}>{title}</div>
                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{artist} â€¢ {demo.genre || 'Unclassified'}</div>
                            <a href={demo.url} target="_blank" rel="noopener noreferrer"
                                onClick={e => e.stopPropagation()}
                                style={{ display: 'block', fontSize: '11px', color: 'var(--primary)', marginTop: '4px', textDecoration: 'none', opacity: 0.8 }}
                                onMouseEnter={e => e.target.style.opacity = 1}
                                onMouseLeave={e => e.target.style.opacity = 0.8}
                            >
                                <i className="ri-external-link-line" style={{ marginRight: '4px' }}></i>
                                Open Source Link
                            </a>
                        </div>
                    </div>

                    <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '4px', minWidth: '140px' }}>
                        {/* Eye Toggle (Top Right) */}
                        <div
                            onClick={toggleStats}
                            style={{ cursor: 'pointer', opacity: 0.7, marginBottom: '4px' }}
                            title={statsVisible ? "Hide Tally" : "Show Vote Tally"}
                            aria-label={`Reveal vote tally for ${title}`}
                        >
                            <i className={statsVisible ? "ri-eye-off-line" : "ri-eye-line"} style={{ fontSize: '14px', color: 'var(--text-secondary)' }}></i>
                        </div>

                        {/* Revealed Stats Block (Tally + Stars) */}
                        {statsVisible && (
                            <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'flex-end', gap: '2px', marginBottom: '6px' }}>
                                <div style={{
                                    fontSize: '11px', color: 'var(--text-secondary)', background: 'rgba(0,0,0,0.3)', padding: '4px 8px', borderRadius: '4px', whiteSpace: 'nowrap'
                                }}>
                                    {loadingStats ? 'Loading...' :
                                        `Votes: ${stats.artistVotes || 0} / ${stats.totalVotes || 0} (${((stats.ratio || 0) * 100).toFixed(1)}%)`
                                    }
                                </div>
                                {/* Stars Display */}
                                <div style={{ display: 'flex', gap: '2px' }}>
                                    {[1, 2, 3, 4, 5].map(star => (
                                        <i key={star} className={star <= (stats.stars || 0) ? "ri-star-fill" : "ri-star-line"} style={{ color: star <= (stats.stars || 0) ? '#ffd700' : '#444', fontSize: '14px' }}></i>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Vote Controls (Mutually Exclusive Appearance for Clarity, as requested) */}
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <button
                                onClick={(e) => handleVote('add', e)}
                                disabled={hasVoted}
                                style={{
                                    background: 'none', border: 'none', cursor: hasVoted ? 'default' : 'pointer',
                                    color: hasVoted ? '#333' : 'var(--primary)', // Dim if already voted
                                    fontWeight: 'bold', fontSize: '18px', width: '24px', height: '24px', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    transition: 'color 0.2s'
                                }}
                                title={hasVoted ? "Already Voted" : "Cast Vote"}
                            >
                                <i className="ri-add-circle-line"></i>
                            </button>
                            <button
                                onClick={(e) => handleVote('remove', e)}
                                disabled={!hasVoted}
                                style={{
                                    background: 'none', border: 'none', cursor: !hasVoted ? 'default' : 'pointer',
                                    color: !hasVoted ? '#333' : '#ff4444', // Dim if not voted
                                    fontWeight: 'bold', fontSize: '18px', width: '24px', height: '24px', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                    transition: 'color 0.2s'
                                }}
                                title={!hasVoted ? "No Vote to Remove" : "Remove Vote"}
                            >
                                <i className="ri-subtract-line"></i>
                            </button>
                        </div>

                        {/* Admin Delete */}
                        {user && user.role === 'admin' && (
                            <div onClick={(e) => e.stopPropagation()} style={{ marginTop: '4px' }}>
                                {isDeleting ? (
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px', background: '#300', padding: '2px 6px', borderRadius: '4px' }}>
                                        <span onClick={handleDelete} style={{ color: '#ff4444', cursor: 'pointer', fontSize: '10px', fontWeight: 'bold' }}>CONFIRM</span>
                                        <span onClick={() => setIsDeleting(false)} style={{ color: 'var(--text-secondary)', cursor: 'pointer', fontSize: '10px' }}>CANCEL</span>
                                    </div>
                                ) : (
                                    <i className="ri-delete-bin-line" onClick={() => setIsDeleting(true)} style={{ color: '#660000', cursor: 'pointer', fontSize: '14px', opacity: 0.6 }}></i>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };


        const ArtistManager = ({ authToken, artists, onUpdate }) => {
            const [newArtistName, setNewArtistName] = useState('');
            const [showArchived, setShowArchived] = useState(false);
            const [archivedList, setArchivedList] = useState([]);
            const [tier, setTier] = useState('developing');

            // Filter archived artists securely
            useEffect(() => {
                if (artists) {
                    setArchivedList(artists.filter(a => a.tier === 'archived' || a.status === 'archived'));
                }
            }, [artists]);

            const handleCreate = async () => {
                if (!newArtistName) return;
                try {
                    await fetch(`${API_BASE}/v3/artists`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ name: newArtistName, tier: tier || 'developing' })
                    });
                    setNewArtistName('');
                    if (onUpdate) onUpdate(); // Refresh parent
                    alert('Artist Signed!');
                } catch (e) { alert('Sign failed'); }
            };

            const handleRestore = async (id) => {
                try {
                    await fetch(`${API_BASE}/v3/artists/${id}/restore`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (onUpdate) onUpdate();
                    alert('Artist Restored!');
                } catch (e) { alert('Restore failed'); }
            };

            return (
                <div className="glass-panel" style={{ padding: '24px', marginTop: '24px', marginBottom: '24px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                        <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: 'var(--primary)' }}>ROSTER MANAGEMENT</h3>
                        <button onClick={() => setShowArchived(!showArchived)} style={{ background: 'none', border: 'none', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: '12px' }}>
                            {showArchived ? 'Hide Archives' : 'View Archives'}
                        </button>
                    </div>

                    {/* Quick Sign */}
                    <div style={{ display: 'flex', gap: '12px', marginBottom: '24px', alignItems: 'center' }}>
                        <input
                            placeholder="Artist Name"
                            value={newArtistName}
                            onChange={(e) => setNewArtistName(e.target.value)}
                            style={{ padding: '8px 12px', borderRadius: '4px', border: '1px solid var(--border)', background: 'var(--input-bg)', color: 'var(--text-color)', width: '200px' }}
                        />
                        <select
                            value={tier}
                            onChange={(e) => setTier(e.target.value)}
                            style={{ padding: '8px', borderRadius: '4px', background: 'var(--input-bg)', color: 'var(--text-color)', border: '1px solid var(--border)' }}
                        >
                            <option value="developing">Developing</option>
                            <option value="core">Core</option>
                            <option value="flagship">Flagship</option>
                        </select>
                        <button onClick={handleCreate} style={{ padding: '8px 24px', background: 'var(--primary)', color: '#000', fontWeight: 'bold', border: 'none', borderRadius: '4px', cursor: 'pointer' }}>
                            SIGN ARTIST
                        </button>
                    </div>

                    {/* Archived List */}
                    {showArchived && (
                        <div style={{ background: 'rgba(0,0,0,0.2)', padding: '16px', borderRadius: '8px' }}>
                            <h4 style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '12px' }}>ARCHIVED ARTISTS ({archivedList.length})</h4>
                            {archivedList.length === 0 ? <div style={{ fontSize: '12px', opacity: 0.5 }}>No archived artists.</div> : (
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '8px' }}>
                                    {archivedList.map(a => (
                                        <div key={a.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '8px', background: 'rgba(255,255,255,0.05)', borderRadius: '4px' }}>
                                            <span style={{ fontSize: '13px', fontWeight: 'bold' }}>{a.name}</span>
                                            <button onClick={() => handleRestore(a.id)} style={{ padding: '4px 8px', fontSize: '10px', background: 'var(--primary-dim)', color: 'var(--primary)', border: 'none', cursor: 'pointer', borderRadius: '2px' }}>RESTORE</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };


        const AdminView = ({ authToken, artists = [], onCommand, aiState }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [newUserValues, setNewUserValues] = useState({ email: '', password: '', name: '', role: 'viewer', pageAccess: [] });

            // Available Permissions
            const ALL_PAGES = ['overview', 'roster', 'anr_room', 'ai_lab', 'admin'];

            const fetchUsers = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/v3/users`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (res.ok) {
                        setUsers(await res.json());
                    }
                } catch (e) { console.error(e); }
                setLoading(false);
            };

            const togglePermission = (perm) => {
                setNewUserValues(prev => {
                    const current = prev.pageAccess || [];
                    if (current.includes(perm)) {
                        return { ...prev, pageAccess: current.filter(p => p !== perm) };
                    } else {
                        return { ...prev, pageAccess: [...current, perm] };
                    }
                });
            };

            const handleCreate = async (e) => {
                e.preventDefault();
                try {
                    await fetch(`${API_BASE}/v3/users`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify(newUserValues)
                    });
                    setNewUserValues({ email: '', password: '', name: '', role: 'viewer', pageAccess: [] });
                    fetchUsers();
                } catch (e) { alert('Failed'); }
            };

            const handleDelete = async (id) => {
                if (!confirm('Delete user?')) return;
                try {
                    await fetch(`${API_BASE}/v3/users/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    fetchUsers();
                } catch (e) { alert('Delete failed'); }
            };

            const handleUpdate = async (e) => {
                e.preventDefault();
                try {
                    await fetch(`${API_BASE}/v3/users/${newUserValues.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify(newUserValues)
                    });
                    setNewUserValues({ email: '', password: '', name: '', role: 'viewer', pageAccess: [] });
                    // setEditing(false); // If using modal
                    fetchUsers();
                } catch (e) { alert('Update failed'); }
            };

            const startEdit = (u) => {
                setNewUserValues({ ...u, password: '' });
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            useEffect(() => { fetchUsers(); }, []);

            if (loading) return <div>Loading Admin Panel...</div>;

            const isEditing = !!newUserValues.id;

            return (
                <div style={{ padding: '8px' }}>
                    <h2 style={{ marginBottom: '24px' }}>ADMINISTRATION</h2>

                    {/* Command Center */}
                    {aiState && (
                        <div className="glass-panel" style={{ padding: '16px', marginBottom: '32px', background: 'rgba(0,0,0,0.4)', border: '1px solid var(--primary-dim)' }}>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px', color: 'var(--primary)', fontSize: '12px', fontFamily: 'JetBrains Mono' }}>
                                <i className="ri-terminal-box-line"></i>
                                <span>COMMAND CENTER // v3.1</span>
                            </div>

                            {/* Input */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '16px' }}>
                                <span style={{ color: 'var(--primary)', fontFamily: 'JetBrains Mono' }}>{'>'}</span>
                                <input
                                    value={aiState.query}
                                    onChange={e => aiState.setQuery(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && onCommand()}
                                    placeholder="Enter system command (e.g., 'Archive BlackGummy', 'Sign Skrillex')..."
                                    style={{ flex: 1, background: 'transparent', border: 'none', color: '#fff', fontFamily: 'JetBrains Mono', fontSize: '14px', outline: 'none' }}
                                    autoFocus
                                />
                                {aiState.loading && <span style={{ fontFamily: 'JetBrains Mono', fontSize: '12px', color: 'var(--primary)', animation: 'pulse 1s infinite' }}>PROCESSING...</span>}
                            </div>

                            {/* Output */}
                            {(aiState.response || aiState.loading) && (
                                <div style={{
                                    background: 'rgba(0,0,0,0.3)',
                                    padding: '12px',
                                    borderRadius: '4px',
                                    fontFamily: 'JetBrains Mono',
                                    fontSize: '13px',
                                    color: 'var(--text-secondary)',
                                    lineHeight: '1.6',
                                    whiteSpace: 'pre-wrap'
                                }}>
                                    <span style={{ color: 'var(--primary)' }}>{aiState.response}</span>
                                    {!aiState.response && aiState.loading && <span style={{ opacity: 0.5 }}>Analyzing input stream...</span>}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Roster Manager */}
                    <ArtistManager authToken={authToken} artists={artists} onUpdate={() => window.location.reload()} />

                    <h2 style={{ marginBottom: '24px', marginTop: '48px' }}>TEAM MANAGEMENT</h2>

                    {/* Create User Form */}
                    <div className="glass-panel" style={{ padding: '24px', marginBottom: '32px' }}>
                        <h3 style={{ fontSize: '14px', marginBottom: '16px', color: 'var(--text-secondary)' }}>{isEditing ? 'EDIT TEAM MEMBER' : 'ADD NEW TEAM MEMBER'}</h3>
                        <form onSubmit={isEditing ? handleUpdate : handleCreate} style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr 1fr', gap: '16px', alignItems: 'end' }}>
                            <div>
                                <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: 'var(--text-secondary)' }}>NAME</label>
                                <input required style={{ width: '100%', padding: '8px', background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)' }}
                                    value={newUserValues.name} onChange={e => setNewUserValues({ ...newUserValues, name: e.target.value })} />
                            </div>
                            <div>
                                <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: 'var(--text-secondary)' }}>EMAIL</label>
                                <input required type="email" style={{ width: '100%', padding: '8px', background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)' }}
                                    value={newUserValues.email} onChange={e => setNewUserValues({ ...newUserValues, email: e.target.value })} />
                            </div>
                            <div>
                                <label style={{ display: 'block', fontSize: '11px', marginBottom: '4px', color: 'var(--text-secondary)' }}>PASSWORD {isEditing && '(Leave blank to keep)'}</label>
                                <input type="password" required={!isEditing} style={{ width: '100%', padding: '8px', background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)' }}
                                    value={newUserValues.password} onChange={e => setNewUserValues({ ...newUserValues, password: e.target.value })} />
                            </div>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button type="submit" style={{ flex: 1, padding: '8px', background: 'var(--primary)', color: '#000', fontWeight: 'bold', border: 'none', cursor: 'pointer' }}>
                                    {isEditing ? 'UPDATE' : 'CREATE'}
                                </button>
                                {isEditing && <button type="button" onClick={() => setNewUserValues({ email: '', password: '', name: '', role: 'viewer', pageAccess: [] })} style={{ padding: '8px', background: '#333', color: 'var(--text-color)', border: 'none', cursor: 'pointer' }}>CANCEL</button>}
                            </div>
                        </form>

                        <div style={{ marginTop: '16px' }}>
                            <label style={{ display: 'block', fontSize: '11px', marginBottom: '8px', color: 'var(--text-secondary)' }}>PAGE ACCESS PERMISSIONS</label>
                            <div style={{ display: 'flex', gap: '12px' }}>
                                {ALL_PAGES.map(p => (
                                    <label key={p} style={{ display: 'flex', alignItems: 'center', gap: '6px', fontSize: '13px', cursor: 'pointer' }}>
                                        <input type="checkbox"
                                            checked={(newUserValues.pageAccess || []).includes(p)}
                                            onChange={() => togglePermission(p)}
                                        />
                                        <span style={{ textTransform: 'capitalize' }}>{p.replace('_', ' ')}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* User List */}
                    <div className="glass-panel">
                        <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ textAlign: 'left', borderBottom: '1px solid var(--border)', color: 'var(--text-secondary)', fontSize: '12px' }}>
                                    <th style={{ padding: '16px' }}>NAME</th>
                                    <th style={{ padding: '16px' }}>EMAIL</th>
                                    <th style={{ padding: '16px' }}>ROLE</th>
                                    <th style={{ padding: '16px' }}>ACCESS</th>
                                    <th style={{ padding: '16px' }}>ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {users.map(u => (
                                    <tr key={u.id} style={{ borderBottom: '1px solid rgba(255,255,255,0.05)' }}>
                                        <td style={{ padding: '16px' }}>{u.name}</td>
                                        <td style={{ padding: '16px', color: 'var(--text-secondary)' }}>{u.email}</td>
                                        <td style={{ padding: '16px' }}>
                                            <span style={{
                                                padding: '4px 8px', borderRadius: '4px', fontSize: '11px',
                                                background: u.role === 'admin' ? 'var(--primary)' : '#333',
                                                color: u.role === 'admin' ? '#000' : '#fff'
                                            }}>{u.role.toUpperCase()}</span>
                                        </td>
                                        <td style={{ padding: '16px', fontSize: '12px', color: '#aaa' }}>
                                            {(u.pageAccess && u.pageAccess.includes('all')) ? 'FULL SYSTEM' : (u.pageAccess || []).join(', ')}
                                        </td>
                                        <td style={{ padding: '16px' }}>
                                            <button onClick={() => startEdit(u)} style={{ color: 'var(--primary)', background: 'none', border: 'none', cursor: 'pointer', fontSize: '12px', marginRight: '12px' }}>EDIT</button>
                                            <button onClick={() => handleDelete(u.id)} style={{ color: '#ff4444', background: 'none', border: 'none', cursor: 'pointer', fontSize: '12px' }}>REMOVE</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const FanHeatmap = ({ authToken, dataset = null, title = "GLOBAL HEATMAP" }) => {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);

            useEffect(() => {
                const initMap = async () => {
                    if (!mapRef.current) return;

                    // Init Map
                    if (!mapInstance.current) {
                        try {
                            mapInstance.current = L.map(mapRef.current, {
                                center: [10, 0], // Shifted South to ensure Oceania/South America aren't clipped
                                zoom: 2,
                                minZoom: 1.5,
                                maxBounds: [[-90, -200], [90, 200]],
                                maxBoundsViscosity: 0.5,
                                zoomControl: false,
                                attributionControl: false
                            });

                            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                                subdomains: 'abcd',
                                maxZoom: 19,
                                noWrap: true
                            }).addTo(mapInstance.current);
                        } catch (e) {
                            console.error("Leaflet Init Error:", e);
                            return;
                        }
                    }

                    // Fetch Data or Use Prop
                    try {
                        let regions = [];

                        if (dataset) {
                            // Use provided dataset (Artist specific)
                            regions = dataset;
                        } else {
                            // Fetch Global Data
                            const res = await fetch(`${API_BASE}/v3/analytics/geography`, {
                                headers: { 'Authorization': `Bearer ${authToken}` }
                            });
                            const data = await res.json();
                            regions = data.regions;
                        }

                        // Region Centers (Expanded for Cities)
                        const centers = {
                            "North America": [40, -100], "Europe": [52, 20], "Asia": [30, 100],
                            "South America": [-15, -60], "Oceania": [-25, 135], "Africa": [0, 20],
                            // Specific Cities
                            "Los Angeles, US": [34.05, -118.24], "New York, US": [40.71, -74.00],
                            "Miami, US": [25.76, -80.19], "Chicago, US": [41.87, -87.62],
                            "Detroit, US": [42.33, -83.04], "Denver, US": [39.73, -104.99],
                            "San Francisco, US": [37.77, -122.41], "Seattle, US": [47.60, -122.33],
                            "Austin, US": [30.26, -97.74], "Toronto, CA": [43.65, -79.38],
                            "Montreal, CA": [45.50, -73.56], "Vancouver, CA": [49.28, -123.12],
                            "Mexico City, MX": [19.43, -99.13], "London, UK": [51.50, -0.12],
                            "Manchester, UK": [53.48, -2.24], "Glasgow, UK": [55.86, -4.25],
                            "Berlin, DE": [52.52, 13.40], "Paris, FR": [48.85, 2.35],
                            "Amsterdam, NL": [52.36, 4.90], "Ibiza, ES": [38.90, 1.40],
                            "Tokyo, JP": [35.67, 139.65], "Seoul, KR": [37.56, 126.97],
                            "Singapore, SG": [1.35, 103.81], "Sydney, AU": [-33.86, 151.20],
                            "Melbourne, AU": [-37.81, 144.96], "Mumbai, IN": [19.07, 72.87],
                            "Dubai, AE": [25.20, 55.27],
                            "Sao Paulo, BR": [-23.55, -46.63], "Buenos Aires, AR": [-34.60, -58.38],
                            // Venues (Approx Coordinates)
                            "Space, Ibiza": [38.90, 1.40], "Ushuaia, Ibiza": [38.88, 1.40],
                            "Berghain, Berlin": [52.51, 13.44], "Fabric, London": [51.51, -0.10],
                            "Ministry of Sound, London": [51.49, -0.09], "Guvernment, Toronto": [43.64, -79.36],
                            "Womb, Tokyo": [35.65, 139.69], "Zouk, Singapore": [1.29, 103.83],
                            "Palladium, Los Angeles": [34.09, -118.32], "Red Rocks, Denver": [39.66, -105.20],
                            "Output, NYC": [40.72, -73.95], "Stereo, Montreal": [45.49, -73.58],
                            "Warung, Brazil": [-26.95, -48.63], "D-Edge, Sao Paulo": [-23.52, -46.66]
                        };

                        // Clear existing layers (except tiles)
                        mapInstance.current.eachLayer((layer) => {
                            if (layer instanceof L.CircleMarker) {
                                mapInstance.current.removeLayer(layer);
                            }
                        });

                        if (regions && Array.isArray(regions)) {
                            const CONTINENTS = ["North America", "Europe", "Asia", "South America", "Oceania", "Africa"];

                            regions.forEach(r => {
                                const center = centers[r.region];
                                if (center) {
                                    const isContinent = CONTINENTS.includes(r.region);
                                    // 0.15 allows visible "cluster" effect without drift
                                    const scatterLat = isContinent ? 20 : 0.15;
                                    const scatterLng = isContinent ? 40 : 0.15;

                                    // Simulate heat points based on percentage
                                    // Ensure even small regions get at least 5 points to be visible
                                    const rawPoints = Math.ceil((r.percent || 0) / 2);
                                    const points = Math.max(5, rawPoints);
                                    const maxPoints = isContinent ? points : Math.min(points, 20);

                                    for (let i = 0; i < maxPoints; i++) {
                                        const lat = center[0] + (Math.random() - 0.5) * scatterLat;
                                        const lng = center[1] + (Math.random() - 0.5) * scatterLng;

                                        L.circleMarker([lat, lng], {
                                            radius: 4 + Math.random() * 4,
                                            fillColor: '#00FF5F',
                                            color: '#000',
                                            weight: 1,
                                            opacity: 0.2,
                                            fillOpacity: 0.4
                                        })
                                            .bindTooltip(`${r.region}: ${r.percent}%`, { sticky: true, direction: 'top' })
                                            .addTo(mapInstance.current);
                                    }
                                }
                            });
                        }

                    } catch (e) { console.error("Map Data/Render Error", e); }
                };

                // Cleanup function if unmount happens quickly
                initMap();

                return () => {
                    if (mapInstance.current) {
                        try {
                            mapInstance.current.remove();
                            mapInstance.current = null;
                        } catch (e) { /* ignore cleanup errors */ }
                    }
                }
            }, [authToken, dataset]); // Re-run if dataset changes

            return (
                <div className="glass-panel" style={{ padding: '0', gridColumn: 'span 2', height: '400px', display: 'flex', flexDirection: 'column', overflow: 'hidden', position: 'relative' }}>
                    <div style={{ position: 'absolute', top: '16px', left: '16px', zIndex: 900, background: 'rgba(0,0,0,0.6)', padding: '8px 12px', borderRadius: '8px', backdropFilter: 'blur(4px)' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ width: '8px', height: '8px', background: 'var(--primary)', borderRadius: '50%', boxShadow: '0 0 10px var(--primary)' }}></span>
                            <h3 style={{ fontSize: '14px', margin: 0, color: '#fff' }}>{title}</h3>
                        </div>
                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)', fontFamily: 'JetBrains Mono', marginTop: '4px' }}>SOURCE: STREAMING DATA</div>
                    </div>
                    <div ref={mapRef} style={{ width: '100%', height: '100%' }}></div>
                </div>
            );
        };


        const ForecastChart = ({ authToken }) => {
            const chartRef = useRef(null);
            const [chartInstance, setChartInstance] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [salesForm, setSalesForm] = useState({ artistId: '', month: '', revenue: '' });
            const [artists, setArtists] = useState([]);

            const fetchForecast = async () => {
                try {
                    const res = await fetch(`${API_BASE}/v3/analytics/projections`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await res.json();

                    if (chartRef.current && data.chartData) {
                        const ctx = chartRef.current.getContext('2d');
                        if (chartInstance) chartInstance.destroy();

                        const newChart = new Chart(ctx, {
                            type: 'line',
                            data: data.chartData,
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { labels: { color: '#bbb', font: { family: 'Inter' } } },
                                    title: { display: true, text: `REVENUE PROJECTION (${data.entity ? data.entity.toUpperCase() : 'LABEL'})`, color: '#fff', font: { family: 'Inter', size: 14, weight: 'bold' } },
                                    tooltip: {
                                        mode: 'index',
                                        intersect: false,
                                        backgroundColor: 'rgba(0,0,0,0.8)',
                                        titleColor: '#00FF5F',
                                        bodyColor: '#fff',
                                        borderColor: '#333',
                                        borderWidth: 1
                                    }
                                },
                                scales: {
                                    y: {
                                        ticks: { color: '#666', font: { family: 'JetBrains Mono' } },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    },
                                    x: {
                                        ticks: { color: '#666', font: { family: 'JetBrains Mono' } },
                                        grid: { color: 'rgba(255,255,255,0.05)' }
                                    }
                                },
                                interaction: {
                                    mode: 'nearest',
                                    axis: 'x',
                                    intersect: false
                                }
                            }
                        });
                        setChartInstance(newChart);
                    }
                } catch (e) { console.error("Forecast Error:", e); }
            };

            useEffect(() => {
                fetchForecast();
                // Fetch artists for dropdown
                fetch(`${API_BASE}/v3/artists`, { headers: { 'Authorization': `Bearer ${authToken}` } })
                    .then(res => res.json())
                    .then(d => setArtists(d.artists || []))
                    .catch(e => console.error(e));

                return () => { if (chartInstance) chartInstance.destroy(); }
            }, []);

            const handleSalesSubmit = async (e) => {
                e.preventDefault();
                try {
                    await fetch(`${API_BASE}/v3/analytics/sales`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify(salesForm)
                    });
                    setShowModal(false);
                    setSalesForm({ artistId: '', month: '', revenue: '' });
                    fetchForecast(); // Refresh chart
                } catch (err) { alert('Failed to log sales'); }
            };

            return (
                <div className="glass-panel" style={{ padding: '24px', gridColumn: '1 / -1', height: '400px', display: 'flex', flexDirection: 'column', position: 'relative' }}>
                    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', marginBottom: '16px' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ width: '8px', height: '8px', background: 'var(--primary)', borderRadius: '50%', boxShadow: '0 0 10px var(--primary)' }}></span>
                            <h3 style={{ fontSize: '14px', margin: 0 }}>PREDICTIVE ANALYTICS</h3>
                        </div>
                        <div style={{ display: 'flex', gap: '16px', alignItems: 'center' }}>
                            <button onClick={() => setShowModal(true)} style={{ background: 'var(--primary-dim)', border: '1px solid var(--primary)', color: 'var(--primary)', padding: '4px 8px', borderRadius: '4px', cursor: 'pointer', fontSize: '10px' }}>LOG REAL SALES</button>
                            <div style={{ fontSize: '11px', color: 'var(--text-secondary)', fontFamily: 'JetBrains Mono' }}>MODEL: LINEAR REGRESSION</div>
                        </div>
                    </div>
                    <div style={{ flex: 1, position: 'relative' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>

                    {/* Sales Input Modal */}
                    {showModal && (
                        <div style={{ position: 'absolute', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(5px)', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '12px', zIndex: 10 }}>
                            <div style={{ background: '#111', padding: '24px', borderRadius: '8px', border: '1px solid var(--border)', width: '300px' }}>
                                <h4 style={{ marginBottom: '16px', color: '#fff' }}>Log Actual Revenue</h4>
                                <form onSubmit={handleSalesSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                    <select value={salesForm.artistId} onChange={e => setSalesForm({ ...salesForm, artistId: e.target.value })} style={{ padding: '8px', background: 'var(--input-bg)', color: 'var(--text-color)', border: '1px solid var(--border)' }} required>
                                        <option value="">Select Artist</option>
                                        {artists.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                    </select>
                                    <input type="month" value={salesForm.month} onChange={e => setSalesForm({ ...salesForm, month: e.target.value })} style={{ padding: '8px', background: 'var(--input-bg)', color: 'var(--text-color)', border: '1px solid var(--border)' }} required />
                                    <input type="number" placeholder="Revenue ($)" value={salesForm.revenue} onChange={e => setSalesForm({ ...salesForm, revenue: e.target.value })} style={{ padding: '8px', background: 'var(--input-bg)', color: 'var(--text-color)', border: '1px solid var(--border)' }} required />
                                    <div style={{ display: 'flex', gap: '8px', marginTop: '8px' }}>
                                        <button type="submit" style={{ flex: 1, padding: '8px', background: 'var(--primary)', border: 'none', color: '#000', fontWeight: 'bold', cursor: 'pointer' }}>SAVE</button>
                                        <button type="button" onClick={() => setShowModal(false)} style={{ flex: 1, padding: '8px', background: 'transparent', border: '1px solid var(--border)', color: '#fff', cursor: 'pointer' }}>CANCEL</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const FanEngagementView = ({ authToken }) => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/v3/fans/demographics`, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        const json = await res.json();
                        setData(json);
                    } catch (err) {
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            if (loading) return <div>Loading Intelligence...</div>;

            return (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>

                    {/* Predictive Analytics */}
                    <ForecastChart authToken={authToken} />

                    {/* Top Movers Leaderboard */}
                    <div className="glass-panel" style={{ padding: '24px', gridColumn: '1 / -1' }}>
                        <h3 style={{ marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <span style={{ width: '8px', height: '8px', background: 'var(--primary)', borderRadius: '50%', boxShadow: '0 0 10px var(--primary)' }}></span>
                            MOMENTUM RADAR (TOP MOVERS)
                        </h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px' }}>
                            {data.topMovers.map((artist, i) => (
                                <div key={artist.id} style={{
                                    background: 'var(--card-overlay)',
                                    padding: '16px',
                                    borderRadius: '8px',
                                    borderLeft: `2px solid ${i === 0 ? 'var(--primary)' : 'rgba(255,255,255,0.1)'}`
                                }}>
                                    <div style={{ fontSize: '10px', color: 'var(--text-secondary)', marginBottom: '4px' }}>RANK #{i + 1}</div>
                                    <div style={{ fontWeight: 'bold', fontSize: '14px', marginBottom: '8px' }}>{artist.name}</div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px' }}>
                                        <span style={{ color: 'var(--text-secondary)' }}>Growth</span>
                                        <span className="text-neon">+{artist.growth}%</span>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginTop: '4px' }}>
                                        <span style={{ color: 'var(--text-secondary)' }}>Engage</span>
                                        <span>{artist.engagement}%</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Demographics */}
                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h3 style={{ marginBottom: '20px' }}>GLOBAL AUDIENCE (AGE)</h3>
                        <div style={{ display: 'flex', alignItems: 'flex-end', height: '150px', gap: '20px' }}>
                            {data.demographics.age.map(group => (
                                <div key={group.range} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '8px' }}>
                                    <div style={{ width: '100%', height: `${group.value * 2}px`, background: 'var(--primary-dim)', borderRadius: '4px 4px 0 0', position: 'relative' }}>
                                        <div style={{ position: 'absolute', top: '-20px', width: '100%', textAlign: 'center', fontSize: '12px', color: 'var(--primary)' }}>{group.value}%</div>
                                    </div>
                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{group.range}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h3 style={{ marginBottom: '20px' }}>PLATFORM MOMENTUM</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                            {data.demographics.platformGrowth.map(p => (
                                <div key={p.platform}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '6px' }}>
                                        <span>{p.platform}</span>
                                        <span className="text-neon" style={{ fontWeight: 'bold' }}>+{p.growth}%</span>
                                    </div>
                                    <div style={{ height: '4px', background: 'var(--card-overlay)', borderRadius: '2px' }}>
                                        <div style={{ width: `${p.growth * 3}%`, height: '100%', background: p.platform === 'TikTok' ? '#ff0055' : 'var(--primary)' }}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Top Regions */}
                    <div className="glass-panel" style={{ padding: '24px', gridColumn: '1 / -1' }}>
                        <h3 style={{ marginBottom: '20px' }}>TOP REGIONS</h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(5, 1fr)', gap: '16px' }}>
                            {data.demographics.locations.map((loc, i) => (
                                <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                    <div style={{ color: 'var(--text-secondary)', fontWeight: 'bold' }}>{i + 1}</div>
                                    <div>
                                        <div style={{ fontSize: '14px' }}>{loc.city}</div>
                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{loc.country}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Lightbox Overlay */}
                    {
                        zoomImage && (
                            <div
                                onClick={() => setZoomImage(null)}
                                style={{
                                    position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.95)', zIndex: 200,
                                    display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'zoom-out'
                                }}
                            >
                                <img
                                    src={zoomImage}
                                    style={{ maxHeight: '90vh', maxWidth: '90vw', borderRadius: '4px', boxShadow: '0 0 50px rgba(0,0,0,0.5)' }}
                                />
                                <div style={{ position: 'absolute', bottom: '40px', color: 'var(--text-secondary)', fontSize: '12px' }}>
                                    Click anywhere to close
                                </div>
                            </div>
                        )
                    }
                </div>
            );
        };

        const CampaignsView = ({ authToken }) => {
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showWizard, setShowWizard] = useState(false);
            const [step, setStep] = useState(1);
            const [form, setForm] = useState({ artistId: '', type: 'playlist-push', budget: '', platforms: [] });
            const [artists, setArtists] = useState([]);
            const [plan, setPlan] = useState(null);
            const [wizardLoading, setWizardLoading] = useState(false);

            useEffect(() => {
                const fetchStats = async () => {
                    try {
                        const [statsRes, artistsRes] = await Promise.all([
                            fetch(`${API_BASE}/v3/campaigns/stats`, { headers: { 'Authorization': `Bearer ${authToken}` } }),
                            fetch(`${API_BASE}/v3/artists`, { headers: { 'Authorization': `Bearer ${authToken}` } })
                        ]);
                        setData(await statsRes.json());
                        const artistData = await artistsRes.json();
                        setArtists(artistData.artists || []);
                    } catch (err) { console.error(err); }
                    finally { setLoading(false); }
                };
                fetchStats();
            }, []);

            const generateCampaign = async () => {
                setWizardLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/v3/marketing/campaigns`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify(form)
                    });
                    const result = await res.json();
                    setPlan(result);
                    setStep(3);
                } catch (err) { alert('Error generating campaign'); }
                finally { setWizardLoading(false); }
            };

            const togglePlatform = (p) => {
                if (form.platforms.includes(p)) setForm({ ...form, platforms: form.platforms.filter(x => x !== p) });
                else setForm({ ...form, platforms: [...form.platforms, p] });
            };

            if (loading) return <div>Loading Campaigns...</div>;

            return (
                <div style={{ display: 'grid', gridTemplateColumns: 'minmax(0, 2fr) minmax(0, 1fr)', gap: '24px', position: 'relative' }}>

                    {/* Header Action */}
                    <div style={{ gridColumn: '1 / -1', display: 'flex', justifyContent: 'flex-end' }}>
                        <button onClick={() => { setShowWizard(true); setStep(1); setPlan(null); }} style={{ background: 'var(--primary)', color: '#000', padding: '10px 20px', border: 'none', borderRadius: '4px', fontWeight: 'bold', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            <i className="ri-flashlight-line"></i> NEW CAMPAIGN
                        </button>
                    </div>

                    {/* Presale Funnel */}
                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h3 style={{ marginBottom: '20px' }}>PRESALE FUNNEL (EMAIL/SMS)</h3>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '32px' }}>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>4.2M</div>
                                <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>TOTAL IMPRESSIONS</div>
                            </div>
                            <div style={{ fontSize: '24px', color: 'var(--primary)' }}><i className="ri-arrow-right-line"></i></div>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{(data.stats.totalEmails + data.stats.totalSMS).toLocaleString()}</div>
                                <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>TOTAL SUBSCRIBERS</div>
                            </div>
                            <div style={{ fontSize: '24px', color: 'var(--primary)' }}><i className="ri-arrow-right-line"></i></div>
                            <div style={{ textAlign: 'center' }}>
                                <div style={{ fontSize: '32px', fontWeight: 'bold', color: 'var(--primary)' }}>{data.stats.presaleSignups.toLocaleString()}</div>
                                <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>VERIFIED PRESALE</div>
                            </div>
                        </div>
                        <div style={{ height: '20px', background: 'var(--card-overlay)', borderRadius: '10px', width: '100%' }}>
                            <div style={{ width: '65%', height: '100%', background: 'linear-gradient(90deg, #0044ff, var(--primary))', borderRadius: '10px' }}></div>
                        </div>
                        <div style={{ textAlign: 'center', marginTop: '8px', fontSize: '12px', color: 'var(--text-secondary)' }}>Conversion Rate: 32% (Above Industry Avg)</div>
                    </div>

                    {/* Database Health */}
                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h3 style={{ marginBottom: '20px' }}>DATABASE GROWTH</h3>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>EMAIL OPT-INS</span>
                                <span className="mono" style={{ fontWeight: 'bold' }}>{data.stats.totalEmails.toLocaleString()} (+12%)</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <span>SMS (TEXT)</span>
                                <span className="mono" style={{ fontWeight: 'bold', color: 'var(--primary)' }}>{data.stats.totalSMS.toLocaleString()} (+28%)</span>
                            </div>
                        </div>
                        <div style={{ marginTop: '24px', height: '100px', display: 'flex', alignItems: 'flex-end', gap: '8px' }}>
                            {data.history.map((m, i) => (
                                <div key={i} style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '2px' }}>
                                    <div style={{ height: `${(m.sms / m.email) * 100}%`, background: 'var(--primary)', opacity: 0.8, borderRadius: '2px' }}></div>
                                    <div style={{ height: '40%', background: 'var(--card-overlay)', opacity: 0.2, borderRadius: '2px' }}></div>
                                </div>
                            ))}
                        </div>
                        <div style={{ textAlign: 'center', fontSize: '10px', color: 'var(--text-secondary)', marginTop: '8px' }}>6-MONTH GROWTH TRAJECTORY</div>
                    </div>

                    {/* Campaign Wizard Modal */}
                    {showWizard && (
                        <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.85)', backdropFilter: 'blur(10px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 3000 }}>
                            <div className="glass-panel" style={{ width: '600px', padding: '32px', border: '1px solid var(--primary)', boxShadow: '0 0 50px rgba(0,255,95,0.1)' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '24px' }}>
                                    <h2 style={{ fontSize: '24px', margin: 0 }}>Create Marketing Campaign</h2>
                                    <button onClick={() => setShowWizard(false)} style={{ background: 'none', border: 'none', color: '#fff', fontSize: '24px', cursor: 'pointer' }}><i className="ri-close-line"></i></button>
                                </div>

                                {/* Step Indicator */}
                                <div style={{ display: 'flex', gap: '8px', marginBottom: '32px' }}>
                                    {[1, 2, 3].map(s => (
                                        <div key={s} style={{ flex: 1, height: '4px', background: step >= s ? 'var(--primary)' : 'var(--card-overlay)', borderRadius: '2px' }}></div>
                                    ))}
                                </div>

                                {step === 1 && (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                        <label>Select Artist</label>
                                        <select value={form.artistId} onChange={e => setForm({ ...form, artistId: e.target.value })} style={{ padding: '12px', background: 'var(--input-bg)', color: '#fff', border: '1px solid var(--border)', borderRadius: '4px' }}>
                                            <option value="">Choose Artist</option>
                                            {artists.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                                        </select>
                                        <label>Campaign Goal</label>
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '12px' }}>
                                            {['playlist-push', 'social-growth', 'tour-promo'].map(t => (
                                                <div key={t} onClick={() => setForm({ ...form, type: t })} style={{ padding: '16px', border: form.type === t ? '1px solid var(--primary)' : '1px solid var(--border)', background: form.type === t ? 'var(--primary-dim)' : 'transparent', cursor: 'pointer', textAlign: 'center', borderRadius: '4px' }}>
                                                    {t.replace('-', ' ').toUpperCase()}
                                                </div>
                                            ))}
                                        </div>
                                        <div style={{ display: 'flex', justifySelf: 'end', marginTop: '16px' }}>
                                            <button onClick={() => setStep(2)} disabled={!form.artistId} style={{ width: '100%', padding: '12px', background: 'var(--primary)', color: '#000', border: 'none', borderRadius: '4px', fontWeight: 'bold' }}>NEXT STEP</button>
                                        </div>
                                    </div>
                                )}

                                {step === 2 && (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                        <label>Platforms</label>
                                        <div style={{ display: 'flex', gap: '12px' }}>
                                            {['Spotify', 'Instagram', 'TikTok', 'Email'].map(p => (
                                                <button key={p} onClick={() => togglePlatform(p)} style={{ flex: 1, padding: '10px', background: form.platforms.includes(p) ? '#fff' : 'transparent', color: form.platforms.includes(p) ? '#000' : '#fff', border: '1px solid #fff', borderRadius: '20px', cursor: 'pointer' }}>{p}</button>
                                            ))}
                                        </div>
                                        <label>Budget ($)</label>
                                        <input type="number" placeholder="5000" value={form.budget} onChange={e => setForm({ ...form, budget: e.target.value })} style={{ padding: '12px', background: 'var(--input-bg)', color: '#fff', border: '1px solid var(--border)', borderRadius: '4px' }} />

                                        <div style={{ display: 'flex', gap: '12px', marginTop: '16px' }}>
                                            <button onClick={() => setStep(1)} style={{ flex: 1, padding: '12px', background: 'transparent', border: '1px solid var(--border)', color: '#fff', borderRadius: '4px' }}>BACK</button>
                                            <button onClick={generateCampaign} disabled={wizardLoading} style={{ flex: 1, padding: '12px', background: 'var(--primary)', color: '#000', border: 'none', borderRadius: '4px', fontWeight: 'bold' }}>{wizardLoading ? 'GENERATING...' : 'LAUNCH CAMPAIGN'}</button>
                                        </div>
                                    </div>
                                )}

                                {step === 3 && plan && (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                        <div style={{ background: 'rgba(0,255,95,0.1)', padding: '16px', borderRadius: '4px', border: '1px solid var(--primary)', textAlign: 'center' }}>
                                            <i className="ri-check-double-line" style={{ fontSize: '24px', color: 'var(--primary)' }}></i>
                                            <h3 style={{ margin: '8px 0' }}>Plan Generated: {plan.campaignId}</h3>
                                        </div>
                                        <div style={{ maxHeight: '200px', overflowY: 'auto' }}>
                                            {plan.plan.map((step, i) => (
                                                <div key={i} style={{ padding: '12px', borderBottom: '1px solid var(--border)' }}>
                                                    <div style={{ fontWeight: 'bold', color: 'var(--primary)' }}>Step {step.step}</div>
                                                    <div>{step.action}</div>
                                                    <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>Platform: {step.platform}</div>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={() => setShowWizard(false)} style={{ width: '100%', padding: '12px', background: 'var(--primary)', color: '#000', border: 'none', borderRadius: '4px', fontWeight: 'bold' }}>CLOSE & ACTIVATE</button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const IntegrationsPanel = ({ authToken }) => {
            const [services, setServices] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetchStatus();
            }, []);

            const fetchStatus = async () => {
                try {
                    const res = await fetch(`${API_BASE}/v3/integrations/status`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await res.json();
                    setServices(data.services || []);
                } catch (err) {
                    console.error('Failed to fetch integrations', err);
                } finally {
                    setLoading(false);
                }
            };

            // Assuming this is the function the user intended to modify, based on the instruction's snippet.
            // This function was not present in the original content, so it's added here as per the instruction's context.
            const fetchSubmissions = async () => {
                try {
                    const res = await fetch(`${API_BASE}/v3/anr/state`, {
                        headers: { 'Authorization': `Bearer ${authToken}` } // Using authToken from IntegrationsPanel scope
                    });
                    const data = await res.json();
                    setSubmissions(data.demos || []); // Assuming setSubmissions is defined in the scope where this function would be used
                } catch (err) {
                    console.error('Fetch failed', err);
                }
            };

            const handleConnect = async (serviceId) => {
                try {
                    const res = await fetch(`${API_BASE}/v3/integrations/auth/${serviceId}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await res.json();
                    if (data.success) fetchStatus();
                } catch (err) {
                    alert('Connection failed');
                }
            };

            const handleDisconnect = async (serviceId) => {
                try {
                    await fetch(`${API_BASE}/v3/integrations/disconnect`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ service: serviceId })
                    });
                    fetchStatus();
                } catch (err) {
                    alert('Disconnect failed');
                }
            };

            if (loading) return <div style={{ color: 'var(--text-secondary)' }}>Loading integrations...</div>;

            return (
                <div>
                    <h3 style={{ fontSize: '24px', marginBottom: '24px' }}>Third-Party Integrations</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '24px' }}>
                        {services.map(service => (
                            <div key={service.id} className="glass-panel" style={{ padding: '24px', border: service.connected ? '1px solid var(--primary)' : '1px solid transparent' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                                    <div>
                                        <div style={{ fontWeight: 'bold', fontSize: '16px', marginBottom: '4px' }}>{service.name}</div>
                                        <div style={{ fontSize: '12px', color: service.connected ? 'var(--primary)' : '#888' }}>
                                            {service.connected ? 'â— CONNECTED' : 'â—‹ DISCONNECTED'}
                                        </div>
                                    </div>
                                    <i className={`ri-${service.id === 'spotify' ? 'spotify-fill' :
                                        service.id === 'youtube' ? 'youtube-fill' :
                                            service.id === 'tiktok' ? 'video-fill' :
                                                service.id === 'instagram' ? 'instagram-fill' : 'plug-line'}`}
                                        style={{ fontSize: '24px', color: service.connected ? '#fff' : '#444' }}></i>
                                </div>

                                {service.connected ? (
                                    <div>
                                        <div style={{ marginBottom: '16px' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>
                                                <span>API QUOTA</span>
                                                <span>{service.quotaUsed}%</span>
                                            </div>
                                            <div style={{ height: '4px', background: 'var(--card-overlay)', borderRadius: '2px', overflow: 'hidden' }}>
                                                <div style={{ width: `${service.quotaUsed}%`, height: '100%', background: service.quotaUsed > 90 ? '#ff4444' : 'var(--primary)' }}></div>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => handleDisconnect(service.id)}
                                            style={{ width: '100%', padding: '8px', background: 'rgba(255, 0, 0, 0.2)', border: '1px solid rgba(255,0,0,0.3)', color: '#ff4444', borderRadius: '4px', cursor: 'pointer', fontSize: '12px' }}
                                        >
                                            DISCONNECT
                                        </button>
                                    </div>
                                ) : (
                                    <button
                                        onClick={() => handleConnect(service.id)}
                                        style={{ width: '100%', padding: '10px', background: 'var(--primary-dim)', color: 'var(--primary)', border: 'none', borderRadius: '4px', cursor: 'pointer', fontWeight: '600', fontSize: '12px' }}
                                    >
                                        CONNECT
                                    </button>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // Entity Audit Tab Component (extracted to fix hooks violation)
        const EntityAuditTab = ({ artist, authToken, isDayMode }) => {
            const [entityData, setEntityData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [isConfirming, setIsConfirming] = useState(false);

            useEffect(() => {
                const fetchEntityAudit = async (forceRefresh = false) => {
                    try {
                        if (forceRefresh) setIsRefreshing(true);
                        const url = forceRefresh
                            ? `${API_BASE}/v3/artists/${artist.id}/entity-audit?refresh=true`
                            : `${API_BASE}/v3/artists/${artist.id}/entity-audit`;

                        const res = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${authToken}` }
                        });
                        const data = await res.json();
                        setEntityData(data);
                    } catch (error) {
                        console.error('Entity audit failed:', error);
                    } finally {
                        setLoading(false);
                        setIsRefreshing(false);
                    }
                };
                fetchEntityAudit();
            }, [artist.id, authToken]);

            const handleRefresh = async () => {
                // Native confirm replaced by UI state
                setIsConfirming(false);
                setIsRefreshing(true);
                try {
                    const res = await fetch(`${API_BASE}/v3/artists/${artist.id}/entity-audit?refresh=true`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await res.json();
                    setEntityData(data);
                } catch (error) {
                    console.error('Refresh failed:', error);
                } finally {
                    setIsRefreshing(false);
                }
            };

            if (loading) {
                return <div style={{ color: 'var(--text-secondary)', padding: '40px', textAlign: 'center' }}>Loading entity audit...</div>;
            }

            if (!entityData) {
                return <div style={{ color: 'var(--text-secondary)' }}>Entity audit data unavailable.</div>;
            }

            const getHealthColor = (score) => {
                if (score >= 90) return 'var(--primary)';
                if (score >= 75) return isDayMode ? '#dddd00' : '#ffff00';
                if (score >= 60) return '#ff9900';
                return '#ff0000';
            };

            const getHealthLabel = (score) => {
                if (score >= 90) return 'EXCELLENT';
                if (score >= 75) return 'GOOD';
                if (score >= 60) return 'FAIR';
                return 'POOR';
            };

            return (
                <div>
                    {artist.wikipedia && artist.wikipedia.summary && (
                        <div className="glass-panel" style={{ padding: '24px', marginBottom: '24px', display: 'flex', gap: '24px', alignItems: 'flex-start' }}>
                            {artist.wikipedia.thumbnail && (
                                <img src={artist.wikipedia.thumbnail} alt={artist.name} style={{ width: '80px', height: '80px', borderRadius: '50%', objectFit: 'cover', border: '2px solid var(--primary)' }} />
                            )}
                            <div>
                                <h3 style={{ marginBottom: '8px' }}>About {artist.name}</h3>
                                <p style={{ fontSize: '14px', color: 'var(--text-secondary)', lineHeight: '1.6', marginBottom: '12px' }}>
                                    {artist.wikipedia.summary}
                                </p>
                                {artist.wikipedia.wikiUrl && (
                                    <a href={artist.wikipedia.wikiUrl} target="_blank" style={{ fontSize: '12px', color: 'var(--primary)', textDecoration: 'none' }}>
                                        Read more on Wikipedia â†’
                                    </a>
                                )}
                            </div>
                        </div>
                    )}

                    <h3 style={{ marginBottom: '24px' }}>Entity Health Score</h3>

                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '24px' }}>
                        {/* Health Score Gauge */}
                        <div className="glass-panel" style={{ padding: '32px', textAlign: 'center', position: 'relative' }}>
                            <div style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '16px' }}>OVERALL HEALTH</div>
                            <div style={{
                                width: '160px',
                                height: '160px',
                                margin: '0 auto',
                                borderRadius: '50%',
                                background: `conic-gradient(${getHealthColor(entityData.healthScore)} ${entityData.healthScore}%, var(--border) 0)`,
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                position: 'relative'
                            }}>
                                <div style={{
                                    width: '130px',
                                    height: '130px',
                                    borderRadius: '50%',
                                    background: 'var(--panel-bg)',
                                    display: 'flex',
                                    flexDirection: 'column',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}>
                                    <div style={{ fontSize: '48px', fontWeight: 'bold', color: getHealthColor(entityData.healthScore) }}>
                                        {entityData.healthScore}
                                    </div>
                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>/100</div>
                                </div>
                            </div>
                            <div style={{
                                marginTop: '16px',
                                fontSize: '16px',
                                fontWeight: 'bold',
                                color: getHealthColor(entityData.healthScore)
                            }}>
                                {getHealthLabel(entityData.healthScore)}
                            </div>
                            {entityData.cached && (
                                <div style={{ marginTop: '12px', fontSize: '10px', color: 'var(--text-secondary)' }}>
                                    ðŸ“¦ Cached â€¢ Updates every 14 days
                                </div>
                            )}

                            {/* Cost-Aware Refresh Button */}
                            <div style={{ marginTop: '24px' }}>
                                {isConfirming ? (
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', alignItems: 'center', background: 'var(--card-overlay)', padding: '12px', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                        <div style={{ fontSize: '11px', color: 'var(--text-color)', fontWeight: 'bold' }}>âš ï¸ COST WARNING: INCURS API FEES</div>
                                        <div style={{ display: 'flex', gap: '8px' }}>
                                            <button onClick={handleRefresh} style={{ background: 'var(--primary)', color: 'var(--bg-color)', border: 'none', padding: '6px 12px', borderRadius: '4px', cursor: 'pointer', fontWeight: 'bold', fontSize: '11px' }}>
                                                CONFIRM PAY
                                            </button>
                                            <button onClick={() => setIsConfirming(false)} style={{ background: 'transparent', color: 'var(--text-secondary)', border: '1px solid var(--border)', padding: '6px 12px', borderRadius: '4px', cursor: 'pointer', fontSize: '11px' }}>
                                                CANCEL
                                            </button>
                                        </div>
                                    </div>
                                ) : (
                                    <button
                                        onClick={() => setIsConfirming(true)}
                                        disabled={isRefreshing}
                                        style={{
                                            background: 'var(--primary-dim)',
                                            border: '1px solid var(--primary)',
                                            color: 'var(--primary)',
                                            padding: '8px 16px',
                                            borderRadius: '24px',
                                            cursor: 'pointer',
                                            fontWeight: 'bold',
                                            fontSize: '12px',
                                            opacity: isRefreshing ? 0.5 : 1,
                                            display: 'flex', alignItems: 'center', gap: '8px',
                                            width: '100%', justifyContent: 'center'
                                        }}
                                    >
                                        {isRefreshing ? <i className="ri-loader-4-line spin"></i> : <i className="ri-refresh-line"></i>}
                                        {isRefreshing ? 'REFRESHING...' : 'FORCE REFRESH (COST)'}
                                    </button>
                                )}
                                <div style={{ fontSize: '9px', color: 'var(--text-secondary)', marginTop: '4px', fontStyle: 'italic', textAlign: 'center' }}>
                                    Costs real ðŸ’¸ (Live API Calls)
                                </div>
                            </div>
                        </div>

                        {/* Platform Status Cards */}
                        <div>
                            <h4 style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>PLATFORM STATUS</h4>
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '16px' }}>
                                {entityData.platforms && Object.entries(entityData.platforms).map(([platform, data]) => (
                                    <div key={platform} className="glass-panel" style={{ padding: '16px' }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '8px' }}>
                                            <span style={{ fontWeight: 'bold', textTransform: 'capitalize' }}>
                                                {platform.replace('KG', ' KG')}
                                            </span>
                                            <span style={{
                                                fontSize: '20px',
                                                color: data.exists ? 'var(--primary)' : 'var(--text-secondary)'
                                            }}>
                                                {data.exists ? 'âœ“' : 'âœ—'}
                                            </span>
                                        </div>
                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>
                                            {data.status === 'verified' && 'ðŸŸ¢ Verified'}
                                            {data.status === 'not_found' && 'ðŸ”´ Not Found'}
                                            {data.status === 'unconfigured' && 'âšª API Not Configured'}
                                            {data.status === 'error' && 'ðŸŸ¡ Error'}
                                        </div>
                                        {data.url && (
                                            <a href={data.url} target="_blank" style={{
                                                fontSize: '10px',
                                                color: 'var(--primary)',
                                                display: 'block',
                                                marginTop: '8px'
                                            }}>
                                                View â†’
                                            </a>
                                        )}
                                    </div>
                                ))}
                                {!entityData.platforms && <div style={{ color: 'var(--text-secondary)', fontStyle: 'italic' }}>No platform data configured.</div>}
                            </div>
                        </div>
                    </div>

                    {/* Issues List */}
                    {
                        entityData.issues && entityData.issues.length > 0 && (
                            <div className="glass-panel" style={{ padding: '24px', marginTop: '24px' }}>
                                <h4 style={{ marginBottom: '16px', color: 'var(--text-color)' }}>
                                    âš ï¸ Issues Detected ({entityData.issues.length})
                                </h4>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                    {entityData.issues.map((issue, i) => (
                                        <div key={i} style={{
                                            padding: '12px',
                                            background: 'var(--card-overlay)',
                                            border: '1px solid var(--border)',
                                            borderRadius: '8px'
                                        }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                                                <strong style={{ textTransform: 'capitalize' }}>
                                                    {issue.platform || 'Multiple Platforms'}
                                                </strong>
                                                <span style={{
                                                    fontSize: '10px',
                                                    padding: '2px 8px',
                                                    background: issue.severity === 'high' ? 'rgba(255,0,0,0.1)' : issue.severity === 'medium' ? 'rgba(255,153,0,0.1)' : 'rgba(255,255,0,0.1)',
                                                    border: '1px solid var(--border)',
                                                    borderRadius: '8px',
                                                    color: 'var(--text-color)',
                                                    fontWeight: 'bold'
                                                }}>
                                                    {issue.severity.toUpperCase()}
                                                </span>
                                            </div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                                                {issue.issue}
                                            </div>
                                            <div style={{ fontSize: '11px', color: 'var(--text-secondary)', fontStyle: 'italic' }}>
                                                ðŸ’¡ Fix: {issue.recommendation}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )
                    }

                    {/* AI Analysis */}
                    {
                        entityData.aiAnalysis && (
                            <div className="glass-panel" style={{ padding: '24px', marginTop: '24px' }}>
                                <h4 style={{ marginBottom: '16px' }}>ðŸ¤– AI Analysis</h4>
                                <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '16px', lineHeight: '1.6' }}>
                                    {entityData.aiAnalysis.summary}
                                </p>
                                {entityData.aiAnalysis.criticalActions && entityData.aiAnalysis.criticalActions.length > 0 && (
                                    <div>
                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px' }}>TOP PRIORITY ACTIONS:</div>
                                        <ul style={{ paddingLeft: '20px', margin: 0 }}>
                                            {entityData.aiAnalysis.criticalActions.map((action, i) => (
                                                <li key={i} style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '4px' }}>
                                                    {action}
                                                </li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                {entityData.aiAnalysis.correlationInsight && (
                                    <div style={{
                                        marginTop: '16px',
                                        padding: '12px',
                                        background: 'var(--primary-dim)',
                                        border: '1px solid var(--primary)',
                                        borderRadius: '8px'
                                    }}>
                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px' }}>ðŸ“Š CORRELATION INSIGHT:</div>
                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                            {entityData.aiAnalysis.correlationInsight}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )
                    }

                    {/* JSON-LD Schema */}
                    {
                        entityData.schemaLD && (
                            <details className="glass-panel" style={{ padding: '24px', marginTop: '24px' }}>
                                <summary style={{ cursor: 'pointer', fontWeight: 'bold', marginBottom: '16px' }}>
                                    ðŸ“„ View Recommended Schema Markup
                                </summary>
                                <pre style={{
                                    background: 'var(--input-bg)',
                                    padding: '16px',
                                    borderRadius: '8px',
                                    fontSize: '11px',
                                    overflow: 'auto',
                                    maxHeight: '300px',
                                    color: 'var(--text-color)',
                                    fontFamily: 'monospace',
                                    border: '1px solid var(--border)'
                                }}>
                                    {JSON.stringify(entityData.schemaLD, null, 2)}
                                </pre>
                            </details>
                        )
                    }
                </div >
            );
        };

        // Google Knowledge Graph Hook (Step 3 Implementation)
        const useGoogleKG = (artistName, authToken) => {
            const [kgData, setKgData] = useState(null);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (!artistName || !authToken) return;

                setLoading(true);
                setKgData(null);

                fetch(`${API_BASE}/v3/integrations/google-kg?query=${encodeURIComponent(artistName)}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                })
                    .then(res => res.json())
                    .then(json => {
                        if (json.exists) {
                            setKgData(json);
                        } else {
                            setKgData(null);
                        }
                    })
                    .catch(err => {
                        console.error('KG Error:', err);
                        setKgData(null);
                    })
                    .finally(() => setLoading(false));
            }, [artistName, authToken]);

            return { kgData, loading };
        };

        const ArtistDetailView = ({ artist, allArtists = [], onSelect, onBack, authToken, isDayMode }) => {
            const [tab, setTab] = useState('overview');
            const { kgData, loading: kgLoading } = useGoogleKG(artist.name, authToken);

            const [isEditingImage, setIsEditingImage] = useState(false);
            const [zoomImage, setZoomImage] = useState(null);

            if (!artist) return null;

            const handleImageSave = async (url) => {
                if (!url) return;
                try {
                    await fetch(`${API_BASE}/v3/artists/${artist.id}/image`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ imageUrl: url })
                    });
                    // Optimistic update for immediate feedback
                    artist.manualImage = url;
                    setIsEditingImage(false);
                } catch (e) { alert('Failed to update image'); }
            };

            // Navigation Logic
            const currentIndex = allArtists.findIndex(a => a.id === artist.id);
            const handlePrev = () => {
                if (currentIndex > 0) onSelect(allArtists[currentIndex - 1]);
            };
            const handleNext = () => {
                if (currentIndex < allArtists.length - 1) onSelect(allArtists[currentIndex + 1]);
            };

            const tabs = ['overview', 'revenue', 'geography', 'touring', 'merch', 'brand', 'network', 'sustainability', 'entity'];

            return (
                <div style={{ position: 'fixed', inset: 0, background: isDayMode ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.9)', zIndex: 2000, display: 'flex', justifyContent: 'center', alignItems: 'center', padding: '40px' }}>
                    <div className="glass-panel" style={{ width: '1000px', height: '800px', display: 'flex', flexDirection: 'column', position: 'relative' }}>

                        {/* Navigation Controls */}
                        <div style={{ position: 'absolute', top: '20px', right: '20px', display: 'flex', alignItems: 'center', gap: '16px' }}>
                            <div style={{ display: 'flex', gap: '4px' }}>
                                <button onClick={handlePrev} disabled={currentIndex <= 0} style={{
                                    background: 'var(--card-overlay)', border: 'none', color: currentIndex <= 0 ? 'var(--text-secondary)' : 'var(--text-color)',
                                    borderRadius: '4px', width: '32px', height: '32px', cursor: currentIndex <= 0 ? 'default' : 'pointer'
                                }}><i className="ri-arrow-left-line"></i></button>
                                <button onClick={handleNext} disabled={currentIndex >= allArtists.length - 1} style={{
                                    background: 'var(--card-overlay)', border: 'none', color: currentIndex >= allArtists.length - 1 ? 'var(--text-secondary)' : 'var(--text-color)',
                                    borderRadius: '4px', width: '32px', height: '32px', cursor: currentIndex >= allArtists.length - 1 ? 'default' : 'pointer'
                                }}><i className="ri-arrow-right-line"></i></button>
                            </div>
                            <div style={{ width: '1px', height: '24px', background: 'var(--border)' }}></div>
                            <button onClick={onBack} style={{ background: 'transparent', border: 'none', color: 'var(--text-color)', fontSize: '24px', cursor: 'pointer' }}>
                                <i className="ri-close-line"></i>
                            </button>
                        </div>

                        {/* Header */}
                        <div style={{ padding: '32px', borderBottom: '1px solid var(--border)' }}>
                            <h2 style={{ fontSize: '32px', fontWeight: 'bold' }}>{artist.name}</h2>
                            <div style={{ display: 'flex', gap: '16px', marginTop: '8px', color: 'var(--text-secondary)' }}>
                                <span className="mono">{artist.tier.toUpperCase()}</span>
                                <span>â€¢</span>
                                <span>{(artist.monthlyListeners ? (artist.monthlyListeners / 1000000).toFixed(1) : '0.0')}M Monthly Listeners</span>
                            </div>
                            {/* Data Source Badge */}
                            {artist.meta && (
                                <div style={{ marginTop: '16px', display: 'flex', gap: '12px' }}>
                                    <div style={{ fontSize: '11px', padding: '4px 8px', background: 'var(--card-overlay)', borderRadius: '4px', border: '1px solid var(--border)' }}>
                                        <span style={{ color: 'var(--text-secondary)' }}>SOURCE: </span>
                                        <span className="mono" style={{ color: 'var(--text-color)' }}>{(artist.meta.dataSource || 'unknown').toUpperCase().replace('_', ' ')}</span>
                                    </div>
                                    <div style={{ fontSize: '11px', padding: '4px 8px', background: 'var(--card-overlay)', borderRadius: '4px', border: '1px solid var(--border)' }}>
                                        <span style={{ color: 'var(--text-secondary)' }}>UPDATED: </span>
                                        <span className="mono" style={{ color: 'var(--text-color)' }}>{artist.meta.lastUpdated ? new Date(artist.meta.lastUpdated).toLocaleDateString() : 'N/A'}</span>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Tabs */}
                        <div style={{ display: 'flex', borderBottom: '1px solid var(--border)' }}>
                            {tabs.map(t => (
                                <button
                                    key={t}
                                    onClick={() => setTab(t)}
                                    style={{
                                        padding: '16px 24px',
                                        background: tab === t ? 'var(--primary-dim)' : 'transparent',
                                        color: tab === t ? 'var(--primary)' : 'var(--text-secondary)',
                                        border: 'none',
                                        borderBottom: tab === t ? '2px solid var(--primary)' : '2px solid transparent',
                                        cursor: 'pointer',
                                        textTransform: 'uppercase',
                                        fontWeight: 'bold',
                                        fontSize: '12px'
                                    }}
                                >
                                    {t}
                                </button>
                            ))}
                        </div>

                        {/* Content */}
                        <div style={{ flex: 1, padding: '32px', overflow: 'auto' }}>
                            {tab === 'overview' && (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '32px' }}>

                                    {/* Google Knowledge Graph Bio (New Specs) */}
                                    {kgLoading ? (
                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)', fontStyle: 'italic' }}>Fetching KG data...</div>
                                    ) : kgData ? (
                                        <div className="glass-panel" style={{ padding: '24px', display: 'flex', gap: '24px', alignItems: 'flex-start' }}>
                                            <div style={{ position: 'relative', cursor: 'pointer' }}>
                                                {/* Image Display */}
                                                <img
                                                    src={artist.manualImage || kgData.image || 'https://via.placeholder.com/150'}
                                                    onClick={() => setZoomImage(artist.manualImage || kgData.image)}
                                                    style={{ width: '80px', height: '80px', borderRadius: '8px', objectFit: 'cover', border: '1px solid var(--border)' }}
                                                />

                                                {/* Edit Button (Visible for admins - assuming full access implies permission here for simplicity) */}
                                                <div
                                                    onClick={(e) => { e.stopPropagation(); setIsEditingImage(true); }}
                                                    style={{
                                                        position: 'absolute', bottom: '-8px', right: '-8px',
                                                        background: 'var(--card-overlay)', border: '1px solid var(--border)', borderRadius: '50%',
                                                        width: '24px', height: '24px', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                        cursor: 'pointer', zIndex: 10
                                                    }}
                                                    title="Edit Image"
                                                >
                                                    <i className="ri-pencil-line" style={{ fontSize: '12px', color: 'var(--text-color)' }}></i>
                                                </div>
                                            </div>

                                            <div style={{ flex: 1 }}>
                                                {isEditingImage ? (
                                                    <div style={{ marginBottom: '16px' }}>
                                                        <div style={{ fontSize: '11px', marginBottom: '4px', color: 'var(--text-secondary)' }}>MANUAL IMAGE URL</div>
                                                        <div style={{ display: 'flex', gap: '8px' }}>
                                                            <input
                                                                type="text"
                                                                defaultValue={artist.manualImage || ''}
                                                                placeholder="https://..."
                                                                id="manualImageInput"
                                                                style={{
                                                                    background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)',
                                                                    padding: '6px 8px', borderRadius: '4px', flex: 1, fontSize: '12px'
                                                                }}
                                                            />
                                                            <button
                                                                onClick={() => {
                                                                    const url = document.getElementById('manualImageInput').value;
                                                                    handleImageSave(url);
                                                                }}
                                                                style={{ background: 'var(--primary)', color: '#000', border: 'none', borderRadius: '4px', padding: '0 12px', cursor: 'pointer', fontWeight: 'bold', fontSize: '11px' }}
                                                            >
                                                                SAVE
                                                            </button>
                                                            <button
                                                                onClick={() => setIsEditingImage(false)}
                                                                style={{ background: 'transparent', color: 'var(--text-secondary)', border: '1px solid var(--border)', borderRadius: '4px', padding: '0 8px', cursor: 'pointer', fontSize: '11px' }}
                                                            >
                                                                CANCEL
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div style={{ marginBottom: '16px' }}>
                                                        <p style={{ fontSize: '14px', lineHeight: '1.6', color: 'var(--text-secondary)', marginBottom: '8px' }}>
                                                            {kgData.description || "No description available."}
                                                        </p>
                                                        {kgData.url && (
                                                            <a href={kgData.url} target="_blank" style={{ fontSize: '12px', color: 'var(--primary)', textDecoration: 'none', fontWeight: 'bold' }}>
                                                                Official Site â†’
                                                            </a>
                                                        )}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>No KG data available.</div>
                                    )}

                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '32px' }}>
                                        <div className="glass-panel" style={{ padding: '24px' }}>
                                            <h3 style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>KEY METRICS</h3>
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                    <span>ROI Multiplier</span>
                                                    <span className="mono text-neon">{artist.roi}x</span>
                                                </div>
                                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                    <span>Growth Rate</span>
                                                    <span className="mono text-neon">+{artist.growthRate}%</span>
                                                </div>
                                                <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                    <span>Engagement</span>
                                                    <span className="mono text-neon">{artist.social?.engagementRate}%</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Creative Profile */}
                                        {(artist.influences || artist.genreHybrids) && (
                                            <div className="glass-panel" style={{ padding: '24px' }}>
                                                <h3 style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>CREATIVE PROFILE</h3>

                                                {/* Genre Hybrids */}
                                                {artist.genreHybrids && (
                                                    <div style={{ marginBottom: '20px' }}>
                                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '4px', textTransform: 'uppercase' }}>Sonic DNA</div>
                                                        <div style={{ color: 'var(--text-color)', fontSize: '14px', lineHeight: '1.4', fontStyle: 'italic' }}>
                                                            "{artist.genreHybrids}"
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Influences */}
                                                {artist.influences && (
                                                    <div>
                                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)', marginBottom: '8px', textTransform: 'uppercase' }}>Key Influences</div>
                                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                                                            {artist.influences.map(inf => (
                                                                <span key={inf} style={{
                                                                    fontSize: '11px',
                                                                    padding: '4px 8px',
                                                                    background: 'var(--card-overlay)',
                                                                    borderRadius: '4px',
                                                                    color: 'var(--text-secondary)',
                                                                    border: '1px solid var(--border)'
                                                                }}>
                                                                    {inf}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {tab === 'geography' && (
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                                    <div className="glass-panel" style={{ padding: '0', overflow: 'hidden', borderRadius: '12px' }}>
                                        <FanHeatmap
                                            authToken={authToken}
                                            dataset={artist.revenue && artist.revenue.streamingBreakdown ? artist.revenue.streamingBreakdown.byLocation : []}
                                            title={`${artist.name.toUpperCase()} - FAN BASE HEATMAP`}
                                        />
                                    </div>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px' }}>
                                        {(artist.revenue && artist.revenue.streamingBreakdown ? artist.revenue.streamingBreakdown.byLocation : []).map(loc => (
                                            <div key={loc.region} className="glass-panel" style={{ padding: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <div>
                                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{loc.region}</div>
                                                    <div style={{ fontSize: '18px', fontWeight: 'bold' }}>{((loc.value / (artist.totalStreams || 1)) * 100).toFixed(1)}%</div>
                                                </div>
                                                <div style={{ textAlign: 'right' }}>
                                                    <div style={{ fontSize: '14px', color: 'var(--primary)' }}>${loc.value.toLocaleString()}</div>
                                                    <div style={{ fontSize: '10px', color: 'var(--text-secondary)' }}>REVENUE</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {tab === 'revenue' && (
                                <div>
                                    <div style={{ marginTop: '24px' }}>
                                        <h4 style={{ marginBottom: '16px', fontSize: '12px', color: 'var(--text-secondary)' }}>GROK FORECAST (3-MONTH PROJECTION)</h4>
                                        <div style={{ background: 'var(--card-overlay)', padding: '16px', borderRadius: '8px', border: '1px solid var(--border)' }}>
                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '12px' }}>
                                                <div>
                                                    <div style={{ fontSize: '24px', fontWeight: 'bold' }}>{(artist.forecast?.nextMonth / 1000000).toFixed(1)}M</div>
                                                    <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>PREDICTED STREAMS (NEXT MONTH)</div>
                                                </div>
                                                <div style={{ textAlign: 'right' }}>
                                                    <div style={{ color: artist.forecast?.trend === 'up' || artist.forecast?.trend === 'rapid-growth' ? 'var(--primary)' : 'var(--text-secondary)' }}>
                                                        <i className={`ri-arrow-${artist.forecast?.trend === 'rapid-growth' ? 'up-double' : artist.forecast?.trend === 'up' ? 'up' : 'right'}-line`}></i> {artist.forecast?.trend.toUpperCase()}
                                                    </div>
                                                    <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>TREND TRAJECTORY</div>
                                                </div>
                                            </div>
                                            {/* Mock visual line */}
                                            <div style={{ height: '30px', display: 'flex', alignItems: 'flex-end', gap: '4px' }}>
                                                {[30, 45, 60, 55, 70, 85, 90, 80, 95, 100].map((h, i) => (
                                                    <div key={i} style={{ flex: 1, background: i > 6 ? 'var(--primary)' : 'var(--card-overlay)', height: `${h}%`, borderRadius: '2px' }}></div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <h3 style={{ marginBottom: '24px', marginTop: '24px' }}>Stream Location</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: '24px', marginBottom: '32px' }}>
                                        {Object.entries(artist.revenue || {}).map(([key, value]) => {
                                            if (key === 'streamingBreakdown') return null; // Skip object representation
                                            return (
                                                <div key={key} className="glass-panel" style={{ padding: '24px' }}>
                                                    <div style={{ textTransform: 'uppercase', color: 'var(--text-secondary)', fontSize: '12px', marginBottom: '8px' }}>{key}</div>
                                                    <div className="mono" style={{ fontSize: '24px' }}>${value.toLocaleString()}</div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* Streaming Geography */}
                                    {artist.revenue?.streamingBreakdown && (
                                        <div>
                                            <h4 style={{ marginBottom: '16px', color: 'var(--text-secondary)', fontSize: '12px', textTransform: 'uppercase' }}>Stream Location</h4>
                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                                                {artist.revenue.streamingBreakdown.byLocation.map((loc, i) => (
                                                    <div key={i} className="glass-panel" style={{ padding: '16px', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                                        <div>
                                                            <div style={{ fontWeight: 'bold', fontSize: '14px' }}>{loc.region}</div>
                                                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{loc.percent}% of total</div>
                                                        </div>
                                                        <div className="mono" style={{ fontSize: '18px', color: 'var(--primary)' }}>
                                                            ${loc.value.toLocaleString()}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {tab === 'touring' && (
                                <div>
                                    <h3 style={{ marginBottom: '24px' }}>Upcoming Shows</h3>
                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead><tr style={{ textAlign: 'left', color: 'var(--text-secondary)' }}>
                                            <th style={{ padding: '12px' }}>DATE</th><th style={{ padding: '12px' }}>VENUE</th><th style={{ padding: '12px' }}>CITY</th><th style={{ padding: '12px', textAlign: 'right' }}>REVENUE</th>
                                        </tr></thead>
                                        <tbody>
                                            {artist.touring?.shows?.map((show, i) => (
                                                <tr key={i} style={{ borderBottom: '1px solid var(--border)' }}>
                                                    <td style={{ padding: '12px' }}>{show.date}</td>
                                                    <td style={{ padding: '12px' }}>{show.venue}</td>
                                                    <td style={{ padding: '12px' }}>{show.city}</td>
                                                    <td style={{ padding: '12px', textAlign: 'right', fontFamily: 'JetBrains Mono' }}>${show.revenue.toLocaleString()}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {tab === 'merch' && (
                                <div>
                                    <h3 style={{ marginBottom: '24px' }}>Merchandise</h3>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                                        <div className="glass-panel" style={{ padding: '24px' }}>
                                            <h4 style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>Top Items</h4>
                                            <ul>
                                                {artist.merch?.topItems?.map(item => (
                                                    <li key={item} style={{ marginBottom: '8px', color: 'var(--text-color)' }}>{item}</li>
                                                ))}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {tab === 'brand' && (
                                <div>
                                    <h3 style={{ marginBottom: '24px' }}>Active Partnerships</h3>
                                    <div style={{ display: 'grid', gap: '16px' }}>
                                        {artist.brandDeals?.map((deal, i) => (
                                            <div key={i} className="glass-panel" style={{ padding: '16px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                                <span style={{ fontWeight: 'bold' }}>{deal.brand}</span>
                                                <div style={{ display: 'flex', gap: '24px' }}>
                                                    <span className="mono">${deal.value.toLocaleString()}</span>
                                                    <span style={{ color: 'var(--primary)', border: '1px solid var(--primary)', padding: '2px 8px', borderRadius: '4px', fontSize: '10px' }}>{deal.status.toUpperCase()}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                </div>
                            )}

                            {tab === 'network' && (
                                <div>
                                    <h3 style={{ marginBottom: '24px' }}>Collaboration Network</h3>
                                    {artist.collaborations && artist.collaborations.length > 0 ? (
                                        <div style={{ display: 'flex', gap: '16px' }}>
                                            {artist.collaborations.map(collabId => (
                                                <div key={collabId} className="glass-panel" style={{ padding: '16px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                    <div style={{ width: '40px', height: '40px', background: 'var(--card-overlay)', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                                                        <i className="ri-user-line"></i>
                                                    </div>
                                                    <div>
                                                        <div style={{ fontWeight: 'bold', fontSize: '14px' }}>{collabId}</div>
                                                        <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Collaborator</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div style={{ color: 'var(--text-secondary)' }}>No network data available.</div>
                                    )}
                                </div>
                            )}

                            {tab === 'sustainability' && (
                                <div>
                                    <h3 style={{ marginBottom: '24px' }}>Career Sustainability (Longevity)</h3>
                                    {artist.sustainability ? (
                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                                            {/* Left Col: Scores */}
                                            <div className="glass-panel" style={{ padding: '24px' }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '24px' }}>
                                                    <div>
                                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>LONGEVITY SCORE</div>
                                                        <div style={{ fontSize: '32px', fontWeight: 'bold', color: 'var(--primary)' }}>{artist.sustainability.longevityScore}</div>
                                                    </div>
                                                    <div>
                                                        <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>LEGACY IMPACT</div>
                                                        <div style={{ fontSize: '32px', fontWeight: 'bold' }}>{artist.sustainability.legacyImpact}</div>
                                                    </div>
                                                </div>

                                                <div style={{ marginBottom: '16px' }}>
                                                    <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '4px' }}>Burnout Risk</div>
                                                    <div style={{
                                                        color: artist.sustainability.burnoutRisk.toLowerCase().includes('high') ? 'red' :
                                                            artist.sustainability.burnoutRisk.toLowerCase().includes('medium') ? '#FFA500' : 'var(--primary)'
                                                    }}>
                                                        {artist.sustainability.burnoutRisk}
                                                    </div>
                                                </div>

                                                <div>
                                                    <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '4px' }}>Revenue Stability</div>
                                                    <div style={{ color: 'var(--text-secondary)', fontSize: '13px' }}>{artist.sustainability.revenueStability}</div>
                                                </div>
                                            </div>

                                            {/* Right Col: Milestones */}
                                            <div className="glass-panel" style={{ padding: '24px' }}>
                                                <h4 style={{ marginBottom: '16px', color: 'var(--text-secondary)' }}>Progression Milestones</h4>
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                                    {artist.sustainability.progressionMilestones?.map((m, i) => (
                                                        <div key={i} style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                                            <div style={{ width: '8px', height: '8px', borderRadius: '50%', background: 'var(--primary)' }}></div>
                                                            <div>
                                                                <span style={{ fontWeight: 'bold', marginRight: '8px' }}>{m.year}</span>
                                                                <span style={{ color: 'var(--text-secondary)' }}>{m.milestone}</span>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ) : (
                                        <div style={{ color: 'var(--text-secondary)' }}>Sustainability data not available for this artist.</div>
                                    )}
                                </div>
                            )}

                            {/* Entity Health Tab */}
                            {tab === 'entity' && <EntityAuditTab artist={artist} authToken={authToken} isDayMode={isDayMode} />}

                        </div>
                    </div>
                </div >
            );
        };
        const UniversalPlayer = ({ url, isDayMode }) => {
            if (!url) return <div style={{ height: '300px', background: 'var(--input-bg)', display: 'flex', alignItems: 'center', justifyContent: 'center', color: 'var(--text-secondary)', borderRadius: '12px' }}>Select a track to initialize playback module</div>;

            let embed = null;

            if (url.includes('spotify.com')) {
                const spotifyId = url.split('track/')[1]?.split('?')[0];
                if (spotifyId) {
                    embed = <iframe src={`https://open.spotify.com/embed/track/${spotifyId}`} width="100%" height="352" frameBorder="0" allowtransparency="true" allow="encrypted-media"></iframe>;
                }
            } else if (url.includes('soundcloud.com')) {
                embed = <iframe width="100%" height="300" scrolling="no" frameBorder="no" allow="autoplay" src={`https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&color=${isDayMode ? '%23ff0000' : '%2300ff5f'}&auto_play=true&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true`}></iframe>;
            } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                let videoId = '';
                if (url.includes('youtu.be')) videoId = url.split('.be/')[1];
                else videoId = url.split('v=')[1]?.split('&')[0];

                if (videoId) {
                    embed = <iframe width="100%" height="300" src={`https://www.youtube.com/embed/${videoId}?autoplay=1`} title="YouTube video player" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen></iframe>;
                }
            }

            return embed || <div style={{ color: 'red' }}>Unsupported URL format</div>;
        };

        const AnRView = ({ authToken, user, isDayMode }) => {
            const [submissions, setSubmissions] = useState([]);
            const [activeTrack, setActiveTrack] = useState(null);
            const [form, setForm] = useState({ artist: '', track: '', url: '', genre: '' });
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                fetchSubmissions();
            }, []);

            const fetchSubmissions = async () => {
                try {
                    const res = await fetch(`${API_BASE}/v3/anr/state`, { headers: { 'Authorization': `Bearer ${authToken}` } });
                    const data = await res.json();
                    setSubmissions(data.demos || []);
                } catch (err) { console.error(err); }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    setLoading(true);
                    await fetch(`${API_BASE}/v3/anr/submissions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify(form)
                    });
                    setForm({ artist: '', track: '', url: '', genre: '' });
                    fetchSubmissions();
                } catch (err) { alert('Submission failed'); }
                finally { setLoading(false); }
            };

            const handleVote = async (id, direction) => {
                try {
                    await fetch(`${API_BASE}/v3/anr/submissions/${id}/vote`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                        body: JSON.stringify({ direction })
                    });
                    fetchSubmissions();
                } catch (err) { console.error(err); }
            };

            return (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 350px', gap: '24px' }}>
                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h3 style={{ marginBottom: '20px' }}>Demo Submissions</h3>
                        <div style={{ display: 'grid', gap: '16px' }}>
                            {submissions.map(sub => (
                                <DemoRow
                                    key={sub.id}
                                    demo={sub}
                                    authToken={authToken}
                                    onVoteChange={fetchSubmissions}
                                    onPlay={setActiveTrack}
                                    isPlaying={activeTrack?.id === sub.id}
                                    user={user}
                                />
                            ))}
                            {submissions.length === 0 && <div style={{ textAlign: 'center', color: 'var(--text-secondary)', padding: '40px' }}>No submissions in the queue.</div>}
                        </div>
                    </div>

                    <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                        {/* Player */}
                        <div className="glass-panel" style={{ padding: '0', overflow: 'hidden' }}>
                            <div style={{ padding: '16px', borderBottom: '1px solid var(--border)', fontWeight: 'bold', fontSize: '12px', color: 'var(--text-secondary)' }}>NOW PLAYING</div>
                            <div style={{ padding: '0' }}>
                                <UniversalPlayer url={activeTrack?.url} isDayMode={isDayMode} />
                            </div>
                            {activeTrack && (
                                <div style={{ padding: '16px' }}>
                                    <div style={{ fontWeight: 'bold' }}>{activeTrack.track}</div>
                                    <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{activeTrack.artist}</div>
                                </div>
                            )}
                        </div>

                        {/* Submission Form */}
                        <div className="glass-panel" style={{ padding: '24px' }}>
                            <h3 style={{ marginBottom: '16px', fontSize: '16px' }}>Submit Demo</h3>
                            <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                                <input placeholder="Artist Name" value={form.artist} onChange={e => setForm({ ...form, artist: e.target.value })} style={{ padding: '10px', background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)', borderRadius: '4px' }} required />
                                <input placeholder="Track Title" value={form.track} onChange={e => setForm({ ...form, track: e.target.value })} style={{ padding: '10px', background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)', borderRadius: '4px' }} required />
                                <input placeholder="Genre" value={form.genre} onChange={e => setForm({ ...form, genre: e.target.value })} style={{ padding: '10px', background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)', borderRadius: '4px' }} />
                                <input placeholder="URL (Spotify/SoundCloud/YouTube)" value={form.url} onChange={e => setForm({ ...form, url: e.target.value })} style={{ padding: '10px', background: 'var(--input-bg)', border: '1px solid var(--border)', color: 'var(--text-color)', borderRadius: '4px' }} required />
                                <button type="submit" disabled={loading} style={{ padding: '10px', background: 'var(--primary)', color: '#000', border: 'none', borderRadius: '4px', fontWeight: 'bold', cursor: 'pointer' }}>{loading ? 'UPLOADING...' : 'SUBMIT TRACK'}</button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const OperationsView = ({ authToken }) => {
            const [opsData, setOpsData] = useState({
                logistics: [],
                assets: [],
                contracts: []
            });

            useEffect(() => {
                const fetchOps = async () => {
                    const headers = { 'Authorization': `Bearer ${authToken}` };
                    try {
                        const [logRes, astRes, ctrRes] = await Promise.all([
                            fetch(`${API_BASE}/v3/operations/logistics`, { headers }),
                            fetch(`${API_BASE}/v3/operations/assets`, { headers }),
                            fetch(`${API_BASE}/v3/operations/contracts`, { headers })
                        ]);

                        const logistics = await logRes.json();
                        const assets = await astRes.json();
                        const contracts = await ctrRes.json();

                        setOpsData({
                            logistics: logistics.logistics || [],
                            assets: assets.assets || [],
                            contracts: contracts.contracts || []
                        });
                    } catch (err) {
                        console.error('Ops fetch error:', err);
                    }
                };
                fetchOps();
            }, [authToken]);

            return (
                <div style={{ display: 'flex', flexDirection: 'column', gap: '32px' }}>
                    {/* 1. Logistics */}
                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', color: 'var(--primary)' }}>Logistics & Supply Chain</h2>
                        <table style={{ width: '100%', fontSize: '14px', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid var(--primary)', textAlign: 'left' }}>
                                    <th style={{ padding: '8px' }}>Item</th>
                                    <th style={{ padding: '8px' }}>Qty</th>
                                    <th style={{ padding: '8px' }}>Status</th>
                                    <th style={{ padding: '8px' }}>Vendor</th>
                                    <th style={{ padding: '8px' }}>Tracking #</th>
                                    <th style={{ padding: '8px' }}>ETA/Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                {opsData.logistics.map(item => (
                                    <tr key={item.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                        <td style={{ padding: '12px 8px' }}>{item.item}</td>
                                        <td style={{ padding: '12px 8px' }}>{item.quantity}</td>
                                        <td style={{ padding: '12px 8px', color: item.status === 'Low Stock' ? '#ff4444' : 'inherit', fontWeight: item.status === 'Low Stock' ? 'bold' : 'normal' }}>{item.status}</td>
                                        <td style={{ padding: '12px 8px' }}>{item.vendor}</td>
                                        <td style={{ padding: '12px 8px', fontFamily: 'monospace' }}>{item.tracking || 'â€”'}</td>
                                        <td style={{ padding: '12px 8px' }}>{item.eta || item.location || 'Stocked'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* 2. Asset Vault */}
                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', color: 'var(--primary)' }}>Asset Vault</h2>
                        <table style={{ width: '100%', fontSize: '14px', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid var(--primary)', textAlign: 'left' }}>
                                    <th style={{ padding: '8px' }}>Title</th>
                                    <th style={{ padding: '8px' }}>Type</th>
                                    <th style={{ padding: '8px' }}>Artist</th>
                                    <th style={{ padding: '8px' }}>Uploaded Date</th>
                                    <th style={{ padding: '8px' }}>Size</th>
                                    <th style={{ padding: '8px' }}>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {opsData.assets.map(asset => (
                                    <tr key={asset.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                        <td style={{ padding: '12px 8px' }}>{asset.title}</td>
                                        <td style={{ padding: '12px 8px' }}>{asset.type}</td>
                                        <td style={{ padding: '12px 8px' }}>{asset.artist}</td>
                                        <td style={{ padding: '12px 8px' }}>{asset.uploaded}</td>
                                        <td style={{ padding: '12px 8px' }}>{asset.size}</td>
                                        <td style={{ padding: '12px 8px' }}>{asset.status}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* 3. Active Contracts */}
                    <div className="glass-panel" style={{ padding: '24px' }}>
                        <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '16px', color: 'var(--primary)' }}>Active Contracts</h2>
                        <table style={{ width: '100%', fontSize: '14px', borderCollapse: 'collapse' }}>
                            <thead>
                                <tr style={{ borderBottom: '1px solid var(--primary)', textAlign: 'left' }}>
                                    <th style={{ padding: '8px' }}>Artist</th>
                                    <th style={{ padding: '8px' }}>Type</th>
                                    <th style={{ padding: '8px' }}>Signed</th>
                                    <th style={{ padding: '8px' }}>Term</th>
                                    <th style={{ padding: '8px' }}>Advance</th>
                                    <th style={{ padding: '8px' }}>Royalty %</th>
                                    <th style={{ padding: '8px' }}>Status/Next Milestone</th>
                                </tr>
                            </thead>
                            <tbody>
                                {opsData.contracts.map(contract => (
                                    <tr key={contract.id} style={{ borderBottom: '1px solid var(--border)' }}>
                                        <td style={{ padding: '12px 8px' }}>{contract.artist}</td>
                                        <td style={{ padding: '12px 8px' }}>{contract.type}</td>
                                        <td style={{ padding: '12px 8px' }}>{contract.signedDate}</td>
                                        <td style={{ padding: '12px 8px' }}>{contract.term}</td>
                                        <td style={{ padding: '12px 8px' }}>
                                            <div>{contract.advance}</div>
                                            {contract.recoupable && <div style={{ fontSize: '11px', color: 'var(--text-secondary)' }}>{contract.recoupable}</div>}
                                        </td>
                                        <td style={{ padding: '12px 8px' }}>{contract.royaltyRate}</td>
                                        <td style={{ padding: '12px 8px' }}>
                                            <span style={{
                                                padding: '2px 6px',
                                                borderRadius: '4px',
                                                background: 'var(--primary-dim)',
                                                color: 'var(--primary)',
                                                fontSize: '11px',
                                                fontWeight: 'bold',
                                                border: '1px solid var(--primary)'
                                            }}>{contract.status}</span>
                                            {contract.nextMilestone && (
                                                <div style={{ marginTop: '4px', fontSize: '11px', color: 'var(--text-secondary)' }}>
                                                    {contract.nextMilestone}
                                                </div>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };


        const ScoutPanel = ({ authToken, onShortlist }) => {
            const [scoutQuery, setScoutQuery] = useState('');
            const [scoutResults, setScoutResults] = useState([]);
            const [loading, setLoading] = useState(false);

            const handleScout = async () => {
                if (!scoutQuery) return;
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/v3/anr/scout?query=${encodeURIComponent(scoutQuery)}`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await res.json();
                    setScoutResults(data.scouts || []);
                } catch (err) {
                    console.error('Scout error:', err);
                } finally {
                    setLoading(false);
                }
            };

            const handleShortlistFromScout = (artist) => {
                onShortlist(artist);
            };

            return (
                <div className="glass-panel" style={{ padding: '24px', height: '100%' }}>
                    <h2 style={{ fontSize: '24px', fontWeight: 'bold', marginBottom: '24px', color: 'var(--primary)' }}>Artist Scouting</h2>

                    <div style={{ display: 'flex', gap: '16px', marginBottom: '24px' }}>
                        <input
                            type="text"
                            placeholder="Search by name, genre..."
                            value={scoutQuery}
                            onChange={(e) => setScoutQuery(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleScout()}
                            style={{ flex: 1, padding: '16px', background: 'rgba(0,0,0,0.3)', border: '1px solid var(--primary)', borderRadius: '4px', color: '#fff' }}
                        />
                        <button
                            onClick={handleScout}
                            style={{ padding: '0 32px', background: 'var(--primary)', color: '#000', borderRadius: '4px', fontWeight: 'bold', cursor: 'pointer', border: 'none' }}
                        >
                            {loading ? '...' : 'Scout'}
                        </button>
                    </div>

                    {scoutResults.length > 0 ? (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '16px', maxHeight: '500px', overflowY: 'auto' }}>
                            {scoutResults.map((artist) => (
                                <div key={artist.spotifyId} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px', background: 'rgba(255,255,255,0.05)', borderRadius: '4px', border: '1px solid rgba(255,255,255,0.1)' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                        <div style={{ width: '64px', height: '64px', background: '#333', borderRadius: '4px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px' }}>?</div>
                                        <div>
                                            <div style={{ fontWeight: 'bold', fontSize: '18px' }}>{artist.name}</div>
                                            <div style={{ fontSize: '14px', opacity: 0.8 }}>
                                                {artist.followers.toLocaleString()} followers â€¢ Popularity {artist.popularity}/100
                                            </div>
                                            <div style={{ fontSize: '14px', color: 'var(--primary-dim)' }}>
                                                {artist.genres.join(', ')}
                                            </div>
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', gap: '12px' }}>
                                        <a href={artist.url} style={{ padding: '8px 16px', background: 'rgba(0,0,0,0.3)', border: '1px solid var(--primary)', borderRadius: '4px', color: '#fff', textDecoration: 'none', display: 'flex', alignItems: 'center' }}>
                                            Listen
                                        </a>
                                        <button
                                            onClick={() => handleShortlistFromScout(artist)}
                                            style={{ padding: '8px 16px', background: 'var(--primary-dim)', color: 'var(--primary)', border: 'none', borderRadius: '4px', cursor: 'pointer', fontWeight: 'bold' }}
                                        >
                                            Shortlist
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        scoutQuery && !loading && (
                            <div style={{ textAlign: 'center', padding: '32px', opacity: 0.6 }}>No artists found â€” try a broader search</div>
                        )
                    )}
                </div>
            );
        };

        const InboxPanel = ({ authToken, shortlistedArtists = [] }) => {
            // ... (Existing implementation from old ScoutingView logic - simplified for Inbox)
            // Renaming old ScoutingView variables to fit "Inbox" context
            const [demos, setDemos] = useState([
                { id: 1, artist: "Ghost Data", track: "Void Walker", date: "2h ago", status: "Unread" },
                { id: 2, artist: "SysDemes", track: "Mainframe", date: "5h ago", status: "Unread" },
                { id: 3, artist: "No Mana", track: "Sihlouette (Demo 4)", date: "1d ago", status: "Shortlist" }
            ]);

            // Merge shortlisted artists into the top of the inbox if desired, or keep separate
            // For this impl, we just show the static list + shortlisted visual confirmation elsewhere

            return (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr 350px', gap: '24px' }}>

                    {/* Main Inbox */}
                    <div className="glass-panel" style={{ padding: '0', overflow: 'hidden' }}>
                        <div style={{ padding: '16px', borderBottom: '1px solid var(--border)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <h3 style={{ fontSize: '16px', fontWeight: 'bold' }}>DEMO INBOX (142)</h3>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                <button style={{ padding: '6px 12px', background: 'var(--input-bg)', border: 'none', color: '#fff', borderRadius: '4px', fontSize: '12px' }}>Filter</button>
                            </div>
                        </div>
                        <div style={{ maxHeight: '600px', overflowY: 'auto' }}>
                            {/* Render Shortlisted items first */}
                            {shortlistedArtists.map(s => (
                                <div key={s.id} style={{ padding: '16px', borderBottom: '1px solid var(--border)', display: 'flex', alignItems: 'center', justifyContent: 'space-between', background: 'rgba(0,255,95,0.05)' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                        <div style={{ width: '40px', height: '40px', background: '#444', borderRadius: '50%', overflow: 'hidden' }}>
                                            {s.imageUrl && <img src={s.imageUrl} alt={s.artist} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />}
                                        </div>
                                        <div>
                                            <div style={{ fontWeight: 'bold' }}>{s.artist} <span style={{ fontSize: '10px', background: 'var(--primary)', color: '#000', padding: '2px 4px', borderRadius: '2px', marginLeft: '8px' }}>SCOUTED</span></div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>Pending Review â€¢ {s.genre}</div>
                                        </div>
                                    </div>
                                    <div>
                                        <button style={{ marginRight: '8px', padding: '6px 12px', background: 'var(--primary)', color: '#000', border: 'none', borderRadius: '20px', fontSize: '12px', fontWeight: 'bold' }}>PLAY</button>
                                    </div>
                                </div>
                            ))}

                            {demos.map(demo => (
                                <div key={demo.id} style={{ padding: '16px', borderBottom: '1px solid var(--border)', display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                        <div style={{ width: '40px', height: '40px', background: '#222', borderRadius: '50%' }}></div>
                                        <div>
                                            <div style={{ fontWeight: 'bold' }}>{demo.artist}</div>
                                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>{demo.track} â€¢ {demo.date}</div>
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button style={{ padding: '6px', background: 'transparent', border: '1px solid var(--border)', color: '#aaa', borderRadius: '4px' }}>Reject</button>
                                        <button style={{ padding: '6px 12px', background: 'var(--primary)', color: '#000', border: 'none', borderRadius: '20px', fontSize: '12px', fontWeight: 'bold' }}>PLAY</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Quick Stats Sidebar (Right) */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                        <div className="glass-panel" style={{ padding: '24px' }}>
                            <h3 style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '16px' }}>WEEKLY STATS</h3>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                <span>Submissions</span>
                                <span style={{ fontWeight: 'bold' }}>842</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                <span>Listen Rate</span>
                                <span style={{ color: 'var(--primary)' }}>92%</span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span>Signed</span>
                                <span>2</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AnRMasterView = ({ authToken }) => {
            const [shortlist, setShortlist] = useState([]);
            const [inboxItems, setInboxItems] = useState([]);

            const fetchSubmissions = async () => {
                try {
                    const res = await fetch(`${API_BASE}/v3/anr/submissions`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    const data = await res.json();

                    // Separate by status if needed, but for now we pass specifically "shortlisted" to inbox top
                    const allItems = data.submissions || [];
                    setInboxItems(allItems);
                    setShortlist(allItems.filter(i => i.status === 'shortlisted'));
                } catch (err) {
                    console.error('Fetch inbox error:', err);
                }
            };

            useEffect(() => {
                fetchSubmissions();
            }, []);

            const handleShortlist = async (artist) => {
                try {
                    await fetch(`${API_BASE}/v3/anr/shortlist`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${authToken}`
                        },
                        body: JSON.stringify(artist)
                    });
                    alert(`${artist.name} added to Shortlist!`);
                    fetchSubmissions(); // Refresh to get the new ID and persistent state
                } catch (err) {
                    console.error('Shortlist error:', err);
                }
            };

            return (
                <div style={{ display: 'grid', gridTemplateColumns: 'minmax(0, 1fr) minmax(0, 1fr)', gap: '32px', marginBottom: '48px' }}>
                    {/* LEFT: Scouting Panel */}
                    <ScoutPanel authToken={authToken} onShortlist={handleShortlist} />

                    {/* RIGHT: Inbox Panel */}
                    <div className="glass-panel" style={{ padding: '0', overflow: 'hidden' }}>
                        <InboxPanel authToken={authToken} shortlistedArtists={shortlist} />
                    </div>
                </div>
            );
        };
        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const [forgotMode, setForgotMode] = useState(false);
            const [resetToken, setResetToken] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [msg, setMsg] = useState('');

            const handleForgot = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/v3/auth/forgot-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    const d = await res.json();
                    setMsg(d.message + ' (Check Console for Token)');
                    setForgotMode('token');
                } catch (e) { setError('Request failed'); }
                setLoading(false);
            };

            const handleReset = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/v3/auth/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, token: resetToken, newPassword })
                    });
                    if (res.ok) {
                        setForgotMode(false);
                        setMsg('Password Reset Successful. Please Login.');
                    } else throw new Error('Reset failed');
                } catch (e) { setError(e.message); }
                setLoading(false);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    const res = await fetch(`${API_BASE}/v3/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                    });

                    const data = await res.json();
                    if (!res.ok) throw new Error(data.error || 'Login failed');

                    onLogin(data.token, data.user);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div style={{
                    display: 'flex', justifyContent: 'center', alignItems: 'center',
                    minHeight: '100vh', flexDirection: 'column',
                    background: 'radial-gradient(circle at 50% 50%, rgba(0, 255, 0, 0.05) 0%, transparent 50%)'
                }}>
                    <div className="glass-panel" style={{ padding: '48px', width: '100%', maxWidth: '420px', border: '1px solid var(--primary-dim)' }}>
                        <div style={{ textAlign: 'center', marginBottom: '32px' }}>
                            <div style={{ fontSize: '32px', fontWeight: 'bold', marginBottom: '8px', letterSpacing: '-1px' }}>mau5trap</div>
                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)', letterSpacing: '2px' }}>INTELLIGENCE PLATFORM</div>
                        </div>

                        {error && (
                            <div style={{
                                background: 'rgba(255, 0, 0, 0.1)', border: '1px solid rgba(255, 0, 0, 0.3)',
                                color: '#ff4444', padding: '12px', borderRadius: '8px', marginBottom: '24px', fontSize: '13px', textAlign: 'center'
                            }}>
                                {error}
                            </div>
                        )}

                        {forgotMode === 'token' ? (
                            <form onSubmit={handleReset}>
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px', fontWeight: 'bold' }}>RESET TOKEN</label>
                                    <input value={resetToken} onChange={e => setResetToken(e.target.value)} style={{ width: '100%', padding: '12px', background: 'var(--input-bg)', border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-color)' }} required />
                                </div>
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px', fontWeight: 'bold' }}>NEW PASSWORD</label>
                                    <input type="password" value={newPassword} onChange={e => setNewPassword(e.target.value)} style={{ width: '100%', padding: '12px', background: 'var(--input-bg)', border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-color)' }} required />
                                </div>
                                <button type="submit" style={{ width: '100%', padding: '14px', background: 'var(--primary)', color: '#000', fontWeight: 'bold', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>RESET PASSWORD</button>
                                <div onClick={() => setForgotMode(false)} style={{ textAlign: 'center', marginTop: '16px', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: '12px' }}>Back to Login</div>
                            </form>
                        ) : forgotMode ? (
                            <form onSubmit={handleForgot}>
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px', fontWeight: 'bold' }}>EMAIL FOR RECOVERY</label>
                                    <input value={email} onChange={e => setEmail(e.target.value)} style={{ width: '100%', padding: '12px', background: 'var(--input-bg)', border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-color)' }} required />
                                </div>
                                <button type="submit" style={{ width: '100%', padding: '14px', background: 'var(--primary)', color: '#000', fontWeight: 'bold', border: 'none', borderRadius: '6px', cursor: 'pointer' }}>SEND RECOVERY LINK</button>
                                <div onClick={() => setForgotMode(false)} style={{ textAlign: 'center', marginTop: '16px', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: '12px' }}>Back to Login</div>
                            </form>
                        ) : (
                            <form onSubmit={handleSubmit}>
                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', fontSize: '12px', color: 'var(--text-secondary)', marginBottom: '8px', fontWeight: 'bold' }}>ACCESS ID</label>
                                    <input
                                        type="email"
                                        value={email}
                                        onChange={e => setEmail(e.target.value)}
                                        placeholder="user@mau5trap.com"
                                        style={{
                                            width: '100%', padding: '12px', background: 'var(--input-bg)',
                                            border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-color)', outline: 'none',
                                            fontFamily: 'JetBrains Mono'
                                        }}
                                    />
                                </div>
                                <div style={{ marginBottom: '32px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '8px' }}>
                                        <label style={{ fontSize: '12px', color: 'var(--text-secondary)', fontWeight: 'bold' }}>PASSPHRASE</label>
                                        <div onClick={() => setForgotMode(true)} style={{ fontSize: '11px', color: 'var(--primary)', cursor: 'pointer' }}>Forgot Password?</div>
                                    </div>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={e => setPassword(e.target.value)}
                                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                                        style={{
                                            width: '100%', padding: '12px', background: 'var(--input-bg)',
                                            border: '1px solid var(--border)', borderRadius: '6px', color: 'var(--text-color)', outline: 'none',
                                            fontFamily: 'JetBrains Mono'
                                        }}
                                    />
                                </div>
                                <button
                                    type="submit"
                                    disabled={loading}
                                    style={{
                                        width: '100%', padding: '14px', background: 'var(--primary)',
                                        color: '#000', fontWeight: 'bold', border: 'none', borderRadius: '6px', cursor: 'pointer',
                                        fontSize: '14px', letterSpacing: '0.5px', opacity: loading ? 0.7 : 1
                                    }}
                                >
                                    {loading ? 'AUTHENTICATING...' : 'INITIALIZE SESSION'}
                                </button>
                            </form>
                        )}
                        {msg && <div style={{ marginTop: '16px', color: 'var(--primary)', fontSize: '12px', textAlign: 'center' }}>{msg}</div>}

                        <div style={{ marginTop: '32px', paddingTop: '24px', borderTop: '1px solid var(--border)', fontSize: '11px', color: 'var(--text-secondary)', textAlign: 'center', lineHeight: '1.6' }}>
                            RESTRICTED ACCESS. UNAUTHORIZED CONNECTIONS WILL BE TERMINATED.<br />
                            <span style={{ color: 'var(--text-secondary)' }}>Authorized personnel only.</span>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [authToken, setAuthToken] = useState(localStorage.getItem('authToken'));
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('userData') || 'null'));
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [aiQuery, setAiQuery] = useState('');
            const [aiResponse, setAiResponse] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedArtist, setSelectedArtist] = useState(null);
            const [sortConfig, setSortConfig] = useState({ key: 'roi', direction: 'desc' });
            const [searchTerm, setSearchTerm] = useState('');
            // Auto-detect theme based on time (6am - 6pm = day)
            const [isDayMode, setIsDayMode] = useState(() => {
                const hour = new Date().getHours();
                return hour >= 6 && hour < 18;
            });

            // Toggle Day/Night Mode Effect
            useEffect(() => {
                if (isDayMode) {
                    document.body.classList.add('day-mode');
                } else {
                    document.body.classList.remove('day-mode');
                }
            }, [isDayMode]);

            // Sort Helper
            const handleSort = (key) => {
                let direction = 'desc';
                if (sortConfig.key === key && sortConfig.direction === 'desc') {
                    direction = 'asc';
                }
                setSortConfig({ key, direction });
            };

            // Process artists for display
            const getSortedArtists = () => {
                if (!data || !data.artists) return [];

                let filtered = [...data.artists];

                // Filter by Search Term
                if (searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    filtered = filtered.filter(a =>
                        (a.displayName && a.displayName.toLowerCase().includes(lowerTerm)) ||
                        (a.name && a.name.toLowerCase().includes(lowerTerm))
                    );
                }

                const sorted = [...filtered];
                sorted.sort((a, b) => {
                    let aVal = a[sortConfig.key];
                    let bVal = b[sortConfig.key];

                    // Handle specific fields
                    if (sortConfig.key === 'monthlyListeners') {
                        aVal = a.monthlyListeners || 0;
                        bVal = b.monthlyListeners || 0;
                    }
                    if (sortConfig.key === 'revenue') {
                        aVal = a.totalRevenue || 0;
                        bVal = b.totalRevenue || 0;
                    }
                    if (sortConfig.key === 'tier') {
                        const tiers = { flagship: 3, developing: 2, scout: 1 };
                        aVal = tiers[a.tier] || 0;
                        bVal = tiers[b.tier] || 0;
                    }

                    if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                return sorted;
            };

            useEffect(() => {
                if (authToken) {
                    fetchData();
                }
            }, [authToken]);

            const handleLogin = (token, userData) => {
                localStorage.setItem('authToken', token);
                localStorage.setItem('userData', JSON.stringify(userData));
                setAuthToken(token);
                setUser(userData);
            };

            const handleLogout = () => {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
                setAuthToken(null);
                setUser(null);
                setData(null);
            };

            const fetchData = async () => {
                try {
                    setLoading(true);

                    const [artistsRes, overviewRes, labelAuditRes] = await Promise.all([
                        fetch(`${API_BASE}/v3/artists?limit=10`, { headers: { 'Authorization': `Bearer ${authToken}` } }),
                        fetch(`${API_BASE}/v3/label/overview`, { headers: { 'Authorization': `Bearer ${authToken}` } }),
                        fetch(`${API_BASE}/v3/label/entity-audit`, { headers: { 'Authorization': `Bearer ${authToken}` } })
                    ]);

                    if (artistsRes.status === 401 || artistsRes.status === 403) {
                        handleLogout();
                        return;
                    }

                    if (!artistsRes.ok || !overviewRes.ok) throw new Error('Failed to connect to Neural Link');

                    const artistsData = await artistsRes.json();
                    const overviewData = await overviewRes.json();
                    const labelAuditData = labelAuditRes.ok ? await labelAuditRes.json() : null;

                    setData({
                        artists: artistsData.artists,
                        stats: overviewData,
                        labelEntity: labelAuditData
                    });
                    window.dashboardArtists = artistsData.artists;
                    setLoading(false);
                } catch (err) {
                    setError(err.message);
                    setLoading(false);
                }
            };

            const handleAI = async () => {
                const q = aiQuery.trim().toLowerCase();
                if (!q) return;
                setAiLoading(true);
                setAiResponse('');
                setAiQuery(''); // Clear input immediately

                // LOCAL COMMAND PARSING
                let commandOutput = null;

                // 1. ARCHIVE PROTOCOL
                if (q.startsWith('archive ')) {
                    const artistName = q.replace('archive ', '').trim();
                    const artist = data.artists.find(a => a.name.toLowerCase() === artistName.toLowerCase());
                    if (artist) {
                        try {
                            await fetch(`${API_BASE}/v3/artists/${artist.id}/archive`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${authToken}` }
                            });
                            commandOutput = `> EXECUTING PROTOCOL: ARCHIVE\n> TARGET: ${artist.name}\n> STATUS: COMPLETED.\n> Entity moved to restricted vault.`;
                            fetchData();
                        } catch (e) { commandOutput = `CRITICAL FAILURE: Unable to archive ${artistName}. Authorization?`; }
                    } else {
                        commandOutput = `TARGET ACQUISITION FAILED: '${artistName}' not found in roster database.`;
                    }
                }
                // 2. RESTORE PROTOCOL
                else if (q.startsWith('restore ')) {
                    const artistName = q.replace('restore ', '').trim();
                    const artist = data.artists.find(a => a.name.toLowerCase() === artistName.toLowerCase());
                    if (artist) {
                        try {
                            await fetch(`${API_BASE}/v3/artists/${artist.id}/restore`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${authToken}` }
                            });
                            commandOutput = `> EXECUTING PROTOCOL: RESTORE\n> TARGET: ${artist.name}\n> STATUS: ACTIVE.\n> Entity reintegrated into the Neural Network.`;
                            fetchData();
                        } catch (e) { commandOutput = `CRITICAL FAILURE: Unable to restore ${artistName}.`; }
                    } else {
                        commandOutput = `TARGET ACQUISITION FAILED: '${artistName}' not found in archives.`;
                    }
                }
                // 3. SIGN PROTOCOL
                else if (q.startsWith('sign ')) {
                    const artistName = q.replace('sign ', '').trim();
                    try {
                        await fetch(`${API_BASE}/v3/artists`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${authToken}` },
                            body: JSON.stringify({ name: artistName, tier: 'developing' }) // Default to developing
                        });
                        commandOutput = `> NEW ENTITY DETECTED.\n> SIGNING PROTOCOL INITIATED.\n> WELCOME: ${artistName}\n> TIER: Developing\n> Smart Contract: GENERATED.`;
                        fetchData();
                    } catch (e) { commandOutput = `SIGNING FAILED: Neural Link rejected the entity.`; }
                }

                // If local command executed, simulate typewriter
                if (commandOutput) {
                    setAiLoading(false);
                    let i = 0;
                    const interval = setInterval(() => {
                        setAiResponse(prev => prev + commandOutput.charAt(i));
                        i++;
                        if (i >= commandOutput.length) clearInterval(interval);
                    }, 10);
                    return;
                }

                // FALLBACK TO STANDARD AI (Backend)
                try {
                    const res = await fetch(`${API_BASE}/v3/ai/query`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${authToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: q }) // Send original query, not lowercase
                    });
                    const d = await res.json();

                    setAiLoading(false);
                    let i = 0;
                    const txt = d.answer || d.insights || "Analysis complete. No significant anomalies detected.";
                    const interval = setInterval(() => {
                        setAiResponse(prev => prev + txt.charAt(i));
                        i++;
                        if (i >= txt.length) clearInterval(interval);
                    }, 15);

                } catch (e) {
                    setAiLoading(false);
                    setAiResponse(`Error: ${e.message}`);
                }
            };

            const downloadReport = async (format) => {
                try {
                    const res = await fetch(`${API_BASE}/v3/exports?format=${format}&timeframe=30d`, {
                        headers: { 'Authorization': `Bearer ${authToken}` }
                    });
                    if (res.ok) {
                        const blob = await res.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `mau5trap_report.${format}`;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                    } else {
                        const err = await res.json();
                        alert(`Export failed: ${err.error}`);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Export failed.");
                }
            };

            if (!authToken) return <LoginScreen onLogin={handleLogin} />;

            if (loading) return (
                <div className="loading-screen">
                    <div className="mau5-head"></div>
                </div>
            );

            if (error) return (
                <div className="loading-screen" style={{ flexDirection: 'column' }}>
                    <i className="ri-error-warning-line" style={{ fontSize: '48px', color: '#ff3333', marginBottom: '20px' }}></i>
                    <h2 style={{ marginBottom: '10px' }}>Connection Failure</h2>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '30px' }}>{error}</p>
                    <button
                        onClick={fetchData}
                        style={{
                            background: '#ff3333', border: 'none', padding: '12px 24px',
                            fontWeight: 'bold', fontSize: '14px', borderRadius: '4px', cursor: 'pointer', color: 'var(--text-color)'
                        }}
                    >
                        RETRY CONNECTION
                    </button>
                </div>
            );

            if (!data) return <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', color: 'var(--text-secondary)' }}>INITIALIZING NEURAL LINK...</div>;

            return (
                <div style={{ display: 'flex', minHeight: '100vh' }}>
                    {/* Sidebar */}
                    <nav style={{
                        width: '260px',
                        borderRight: '1px solid var(--border)',
                        background: 'var(--panel-bg)',
                        backgroundImage: 'var(--decoration-gradient)', /* Added Gradient */
                        backgroundSize: '100% 100%',
                        backdropFilter: 'blur(20px)',
                        padding: '32px 24px',
                        display: 'flex', flexDirection: 'column',
                        position: 'fixed', height: '100vh', zIndex: 10
                    }}>
                        <div style={{ marginBottom: '48px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                            {/* Dynamic Logo Color */}
                            <svg width="40" height="40" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                <g fill={isDayMode ? "#ff0000" : "#00ff00"}>
                                    {/* Left Ear */}
                                    <circle cx="20" cy="30" r="22" />
                                    {/* Right Ear */}
                                    <circle cx="80" cy="30" r="22" />
                                    {/* Head */}
                                    <circle cx="50" cy="60" r="32" />
                                </g>
                                {/* Eyes (White/Negative Space) */}
                                <ellipse cx="40" cy="55" rx="7" ry="9" fill="#fff" transform="rotate(15, 40, 55)" />
                                <ellipse cx="60" cy="55" rx="7" ry="9" fill="#fff" transform="rotate(-15, 60, 55)" />
                                {/* Mouth (White/Negative Space) */}
                                <path d="M 30 70 Q 50 90 70 70 Q 50 82 30 70" fill="#fff" />
                            </svg>
                            <div style={{ display: 'flex', flexDirection: 'column' }}>
                                <span style={{ fontWeight: '800', fontSize: '20px', letterSpacing: '-0.5px', color: 'var(--text-color)' }}>mau5trap</span>
                                <span style={{ fontSize: '10px', color: 'var(--primary)', letterSpacing: '1px', textTransform: 'uppercase' }}>Intelligence Platform</span>
                            </div>
                        </div>

                        <div style={{ display: 'flex', flexDirection: 'column', gap: '8px' }}>
                            {[
                                { id: 'dashboard', label: 'Dashboard', perm: 'overview' },
                                { id: 'artists', label: 'Artists', perm: 'roster' },
                                { id: 'anr', label: 'A&R Room', perm: 'anr_room' },
                                { id: 'intelligence', label: 'Intelligence', perm: 'ai_lab' },
                                { id: 'admin', label: 'Admin', perm: 'admin' },
                            ].filter(tab => {
                                if (user && user.role === 'admin') return true;
                                if (!user || !user.pageAccess) return false;
                                return user.pageAccess.includes('all') || user.pageAccess.includes(tab.perm);
                            }).map(item => (
                                <div
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    style={{
                                        padding: '12px 16px',
                                        borderRadius: '8px',
                                        cursor: 'pointer',
                                        color: activeTab === item.id ? '#fff' : 'var(--text-secondary)',
                                        background: activeTab === item.id ? 'var(--primary-dim)' : 'transparent',
                                        fontWeight: activeTab === item.id ? '600' : '400',
                                        display: 'flex', alignItems: 'center', gap: '12px',
                                        transition: 'all 0.2s'
                                    }}
                                >
                                    <span style={{ marginRight: '12px', fontSize: '18px' }}>
                                        {item.id === 'dashboard' && <i className="ri-dashboard-line"></i>}
                                        {item.id === 'artists' && <i className="ri-user-star-line"></i>}
                                        {item.id === 'anr' && <i className="ri-headphone-line"></i>}
                                        {item.id === 'intelligence' && <i className="ri-brain-line"></i>}
                                        {item.id === 'admin' && <i className="ri-settings-3-line"></i>}
                                    </span>
                                    {item.label}
                                </div>
                            ))}
                        </div>

                        {/* Theme Toggle in Sidebar */}
                        <div
                            onClick={() => setIsDayMode(!isDayMode)}
                            style={{
                                marginTop: 'auto', marginBottom: '16px', padding: '12px 16px',
                                borderRadius: '8px', cursor: 'pointer',
                                color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: '12px',
                                transition: 'all 0.2s'
                            }}
                            onMouseEnter={e => e.currentTarget.style.color = 'var(--text-color)'}
                            onMouseLeave={e => e.currentTarget.style.color = 'var(--text-secondary)'}
                        >
                            <i className={isDayMode ? "ri-moon-line" : "ri-sun-line"} style={{ fontSize: '18px' }}></i>
                            {isDayMode ? "Switch to Night" : "Switch to Day"}
                        </div>

                        <div style={{ borderTop: '1px solid var(--border)', paddingTop: '16px' }}>
                            <div
                                onClick={handleLogout}
                                style={{
                                    display: 'flex', alignItems: 'center', gap: '12px',
                                    color: 'var(--text-secondary)', cursor: 'pointer', fontSize: '14px',
                                    transition: 'color 0.2s'
                                }}
                            >
                                <i className="ri-logout-box-line"></i>
                                Terminate Session
                            </div>
                        </div>
                    </nav>

                    {/* Main Content Area */}
                    <main style={{ marginLeft: '260px', flex: 1, padding: '40px' }}>
                        <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '40px' }}>
                            <div>
                                <h1 style={{ fontSize: '28px', fontWeight: '700', marginBottom: '8px' }}>
                                    {activeTab.charAt(0).toUpperCase() + activeTab.slice(1)}
                                </h1>
                                <div style={{ color: 'var(--text-secondary)', fontSize: '14px' }}>Real-time label performance metrics</div>
                            </div>
                            <div className="glass-panel" style={{ padding: '8px 16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                <img src={`https://ui-avatars.com/api/?name=${user?.name || 'Admin'}&background=random`} style={{ width: '24px', height: '24px', borderRadius: '50%' }} />
                                <span style={{ fontSize: '14px', fontWeight: '500' }}>{user?.name || 'Admin'}</span>
                            </div>
                        </header>

                        {/* Stats Grid */}
                        {/* Label Intelligence & Stats */}
                        {
                            activeTab === 'dashboard' && (
                                <>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '24px', marginBottom: '32px' }}>
                                        <StatCard
                                            label="Total Revenue"
                                            value={`$${(data.stats.totalRevenue / 1000000).toFixed(1)}M`}
                                            sub="+12% vs last month"
                                            delay={0}
                                        />
                                        <StatCard
                                            label="Total Streams"
                                            value={`${(data.stats.totalStreams / 1000000).toFixed(1)}M`}
                                            sub="2.4M daily average"
                                            delay={100}
                                        />
                                        <StatCard
                                            label="Active Artists"
                                            value={data.stats.activeArtists}
                                            sub={`${data.artists.filter(a => a.tier === 'flagship').length} Flagship`}
                                            delay={200}
                                        />
                                        <StatCard
                                            label="Avg ROI"
                                            value={`${data.stats.avgROI}x`}
                                            sub="Target: 5.0x"
                                            delay={300}
                                        />
                                    </div>

                                    {/* PREDICTIVE ANALYTICS CHART (DASHBOARD) */}
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px', marginBottom: '32px' }}>
                                        <ForecastChart authToken={authToken} />
                                        <FanHeatmap authToken={authToken} />
                                    </div>

                                    {data.labelEntity && (
                                        <div className="glass-panel" style={{ padding: '24px', marginBottom: '24px', display: 'flex', gap: '24px', alignItems: 'center', background: 'rgba(0,255,0,0.05)', border: '1px solid rgba(0,255,0,0.2)' }}>
                                            <div style={{ fontSize: '32px', color: 'var(--primary)' }}><i className="ri-shield-check-line"></i></div>
                                            <div style={{ flex: 1 }}>
                                                <div style={{ fontWeight: 'bold', fontSize: '16px', marginBottom: '4px' }}>Label Identity Verified</div>
                                                <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                                                    Mau5trap is fully indexed on Wikipedia, Discogs, and Fandom.
                                                    {data.labelEntity.platforms.wikipedia.summary && <span style={{ marginLeft: '8px', color: 'var(--text-secondary)' }}>"{data.labelEntity.platforms.wikipedia.summary.substring(0, 120)}..."</span>}
                                                </div>
                                            </div>
                                            <div style={{ display: 'flex', gap: '12px' }}>
                                                {data.labelEntity.platforms.wikipedia.url && <a href={data.labelEntity.platforms.wikipedia.url} target="_blank" style={{ color: 'var(--text-color)', fontSize: '20px' }} title="Wikipedia"><i className="ri-global-line"></i></a>}
                                                {data.labelEntity.platforms.fandom.url && <a href={data.labelEntity.platforms.fandom.url} target="_blank" style={{ color: 'var(--text-color)', fontSize: '20px' }} title="Fandom"><i className="ri-book-read-line"></i></a>}
                                                {data.labelEntity.platforms.discogs.url && <a href={data.labelEntity.platforms.discogs.url} target="_blank" style={{ color: 'var(--text-color)', fontSize: '20px' }} title="Discogs"><i className="ri-disc-line"></i></a>}
                                            </div>
                                        </div>
                                    )}
                                </>
                            )
                        }

                        <div style={{ display: 'grid', gridTemplateColumns: '2fr 1fr', gap: '24px' }}>

                            {/* Roster Table */}
                            {(activeTab === 'dashboard' || activeTab === 'artists') && (
                                <div className="glass-panel" style={{ padding: '24px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                            <h3 style={{ fontSize: '18px', fontWeight: '600', margin: 0 }}>Top Performers</h3>
                                            <div style={{ position: 'relative' }}>
                                                <input
                                                    type="text"
                                                    placeholder="Search Roster..."
                                                    value={searchTerm}
                                                    onChange={(e) => setSearchTerm(e.target.value)}
                                                    style={{
                                                        background: 'rgba(0,0,0,0.3)',
                                                        border: '1px solid var(--border)',
                                                        padding: '8px 12px 8px 32px',
                                                        borderRadius: '20px',
                                                        color: 'var(--text-color)',
                                                        fontSize: '12px',
                                                        width: '200px',
                                                        outline: 'none'
                                                    }}
                                                />
                                                <i className="ri-search-line" style={{ position: 'absolute', left: '10px', top: '50%', transform: 'translateY(-50%)', color: 'var(--text-secondary)', fontSize: '12px' }}></i>
                                            </div>
                                        </div>
                                        <button style={{ background: 'transparent', border: '1px solid var(--border)', color: 'var(--text-secondary)', padding: '6px 12px', borderRadius: '6px', cursor: 'pointer', fontSize: '12px' }}>View All</button>
                                    </div>

                                    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                        <thead>
                                            <tr style={{ textAlign: 'left', fontSize: '12px', color: 'var(--text-secondary)', borderBottom: '1px solid rgba(255,255,255,0.1)' }}>
                                                {[
                                                    { label: 'ARTIST', key: 'name' },
                                                    { label: 'TIER', key: 'tier' },
                                                    { label: 'LISTENERS', key: 'monthlyListeners', align: 'right' },
                                                    { label: 'REVENUE', key: 'revenue', align: 'right' },
                                                    { label: 'ROI', key: 'roi', align: 'right' },
                                                ].map(h => (
                                                    <th key={h.key} onClick={() => handleSort(h.key)} style={{ padding: '0 0 12px 16px', fontWeight: '500', textAlign: h.align || 'left', cursor: 'pointer', userSelect: 'none' }}>
                                                        {h.label} {sortConfig.key === h.key ? (sortConfig.direction === 'asc' ? 'â†‘' : 'â†“') : ''}
                                                    </th>
                                                ))}
                                                <th style={{ padding: '0 0 12px 16px', textAlign: 'right', fontWeight: '500' }}>ACTION</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {getSortedArtists().map((artist, i) => (
                                                <ArtistRow
                                                    key={artist.id}
                                                    artist={artist}
                                                    index={i}
                                                    user={user}
                                                    authToken={authToken}
                                                    onUpdate={() => fetchData()}
                                                    onSelect={setSelectedArtist}
                                                />
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {/* AI Console / Intelligence Graph */}
                            {/* Settings / Integrations */}
                            {activeTab === 'settings' && (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <IntegrationsPanel authToken={authToken} />
                                </div>
                            )}

                            {/* Fans Tab */}
                            {activeTab === 'fans' && (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <FanEngagementView authToken={authToken} />
                                </div>
                            )}

                            {/* A&R Tab */}
                            {activeTab === 'anr' && (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <div style={{ gridColumn: '1 / -1' }}>
                                        <AnRView authToken={authToken} user={user} isDayMode={isDayMode} />
                                    </div>
                                </div>
                            )}

                            {/* Campaigns Tab */}
                            {activeTab === 'campaigns' && (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <CampaignsView authToken={authToken} />
                                </div>
                            )}

                            {/* Scouting Tab */}
                            {activeTab === 'scouting' && (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <AnRMasterView authToken={authToken} />
                                </div>
                            )}

                            {/* Operations Tab */}
                            {activeTab === 'operations' && (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <OperationsView authToken={authToken} />
                                </div>
                            )}

                            {/* Admin Tab */}
                            {activeTab === 'admin' && (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <AdminView
                                        authToken={authToken}
                                        artists={data ? data.artists : []}
                                        onCommand={handleAI}
                                        aiState={{
                                            query: aiQuery,
                                            setQuery: setAiQuery,
                                            response: aiResponse,
                                            loading: aiLoading
                                        }}
                                    />
                                </div>
                            )}

                            {activeTab === 'intelligence' ? (
                                <div style={{ gridColumn: '1 / -1' }}>
                                    <h3 style={{ fontSize: '24px', marginBottom: '20px' }}>Global Neural Network</h3>
                                    <IntelligenceGraph artists={data ? data.artists : []} isDayMode={isDayMode} />
                                </div>
                            ) : activeTab === 'admin' ? null : (
                                <div className="glass-panel" style={{ padding: '24px', display: 'flex', flexDirection: 'column' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '20px' }}>
                                        <i className="ri-brain-line" style={{ color: 'var(--primary)', fontSize: '20px' }}></i>
                                        <h3 style={{ fontSize: '18px', fontWeight: '600' }}>Groq Intelligence</h3>
                                    </div>

                                    <div style={{
                                        flex: 1,
                                        background: 'var(--input-bg)',
                                        borderRadius: '8px',
                                        border: '1px solid var(--border)',
                                        marginBottom: '16px',
                                        padding: '16px',
                                        fontFamily: 'JetBrains Mono',
                                        fontSize: '13px',
                                        lineHeight: '1.6',
                                        color: 'var(--text-secondary)',
                                        minHeight: '200px',
                                        position: 'relative',
                                        overflow: 'hidden'
                                    }}>
                                        {/* Scanline overlay */}
                                        <div style={{
                                            position: 'absolute', inset: 0,
                                            background: 'linear-gradient(to bottom, transparent, var(--primary-dim) 50%, transparent)',
                                            animation: 'scanline 4s linear infinite',
                                            pointerEvents: 'none'
                                        }}></div>

                                        {!aiResponse && !aiLoading && <div style={{ color: '#555' }}>// System ready.<br />// Waiting for input...</div>}
                                        {aiLoading && <div style={{ color: 'var(--primary)' }}>// Analyzing neural patterns...<br />// Accessing database...</div>}
                                        {aiResponse}
                                    </div>

                                    <div style={{ position: 'relative' }}>
                                        <input
                                            type="text"
                                            value={aiQuery}
                                            onChange={e => setAiQuery(e.target.value)}
                                            onKeyPress={e => e.key === 'Enter' && handleAI()}
                                            placeholder="Enter command or query..."
                                            style={{
                                                width: '100%',
                                                background: 'var(--card-overlay)',
                                                border: '1px solid var(--border)',
                                                borderRadius: '8px',
                                                padding: '12px 16px',
                                                paddingRight: '48px',
                                                color: 'var(--text-color)',
                                                fontSize: '14px',
                                                fontFamily: 'JetBrains Mono'
                                            }}
                                        />
                                        <button
                                            onClick={handleAI}
                                            style={{
                                                position: 'absolute',
                                                right: '8px',
                                                top: '50%',
                                                transform: 'translateY(-50%)',
                                                background: 'transparent',
                                                border: 'none',
                                                color: aiQuery ? 'var(--primary)' : '#444',
                                                cursor: aiQuery ? 'pointer' : 'default',
                                                transition: 'color 0.2s'
                                            }}
                                        >
                                            <i className="ri-send-plane-fill" style={{ fontSize: '18px' }}></i>
                                        </button>
                                    </div>
                                </div>


                            )}

                        </div>
                    </main >

                    {/* Modals */}
                    {
                        selectedArtist && (
                            <ArtistDetailView
                                artist={selectedArtist}
                                allArtists={data.artists || []}
                                onSelect={setSelectedArtist}
                                onBack={() => setSelectedArtist(null)}
                                authToken={authToken}
                                isDayMode={isDayMode}
                            />
                        )
                    }

                </div >
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>