<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mau5trap Intelligence Platform | LIVE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Chosen Palette: "Horde Terminal" (Dark Mode: bg-black, text-emerald-400, border-emerald-600) -->
    <!-- Application Structure Plan: 
         1. Auth Guard: Checks for token. If missing + in Preview Mode, creates a dummy session to prevent crashing.
         2. Role Logic: Reads user role from localStorage.
         3. Live Data: Async fetch() calls to API.
         4. AI Terminal: Real implementation sending POST requests.
    -->

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        mau5: {
                            black: '#050505',
                            dark: '#0a0a0a',
                            panel: '#111111',
                            green: '#00ff00',
                            greenDim: '#00cc00',
                            text: '#e5e7eb',
                            muted: '#6b7280',
                            error: '#ef4444'
                        }
                    },
                    fontFamily: {
                        mono: ['"Space Mono"', 'monospace'],
                        sans: ['"Inter"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .font-mono {
            font-family: 'Space Mono', monospace;
        }

        .glow-text {
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .terminal-cursor::after {
            content: '‚ñà';
            animation: blink 1s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }
        }

        .chart-container {
            position: relative;
            width: 100%;
            height: 300px;
        }

        .loading-overlay {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>

<body class="bg-mau5-black text-mau5-text antialiased min-h-screen flex flex-col">

    <!-- Auth Guard Script (Runs immediately) -->
    <script>
        // CONFIGURATION - CHANGE THIS TO YOUR LIVE API URL
        const API_BASE = 'http://localhost:3000/v3';

        let token = localStorage.getItem('authToken');
        let userData = JSON.parse(localStorage.getItem('userData') || '{}');

        // FIX: Check environment to prevent crash in Preview/Blob mode
        const isPreview = window.location.protocol === 'blob:' || window.location.href.includes('googleusercontent');

        if (!token) {
            if (isPreview) {
                // In preview, we simulate a login so the user can see the dashboard
                console.warn("Preview Environment Detected: Activating Simulation Session.");
                token = "SIMULATION_TOKEN_123";
                userData = { name: 'Preview Admin', role: 'admin' };
                // We don't save to localStorage to not mess up real testing, just use variables in memory for this session check
            } else {
                // In production, redirect to login
                try {
                    window.location.href = 'login.html';
                } catch (e) {
                    console.error("Redirect failed:", e);
                }
            }
        }
    </script>

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-mau5-black/90 backdrop-blur-md border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div id="status-indicator"
                        class="w-3 h-3 bg-red-500 rounded-full shadow-[0_0_10px_#ef4444] transition-colors duration-500">
                    </div>
                    <span class="font-mono font-bold text-xl tracking-tighter text-white">mau5trap<span
                            class="text-mau5-green">_OS</span></span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-xs font-mono text-gray-500 hidden md:block">LOGGED IN AS: <span
                            class="text-mau5-green" id="user-display-name">...</span></span>
                    <button onclick="logout()"
                        class="text-xs font-mono border border-red-900 text-red-500 px-3 py-1 rounded hover:bg-red-900/20 transition-colors">LOGOUT</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow p-4 md:p-8 max-w-7xl mx-auto w-full">

        <!-- Welcome Header -->
        <header class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white mb-2">Command Center</h1>
                <p class="text-gray-400">Real-time label operations & intelligence.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="fetchData()"
                    class="px-4 py-2 bg-mau5-panel border border-mau5-green text-mau5-green text-xs font-mono rounded hover:bg-mau5-green/10 transition-colors">
                    REFRESH DATA
                </button>
            </div>
        </header>

        <!-- KPI Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-mau5-panel border border-gray-800 rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="text-4xl">üë•</span>
                </div>
                <h3 class="text-gray-500 text-xs font-mono uppercase mb-1">Total Artists</h3>
                <div class="text-3xl font-bold text-white" id="kpi-artists">--</div>
                <div class="text-xs text-mau5-green mt-2">Active Roster</div>
            </div>
            <div class="bg-mau5-panel border border-gray-800 rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="text-4xl">üí∞</span>
                </div>
                <h3 class="text-gray-500 text-xs font-mono uppercase mb-1">Monthly Revenue</h3>
                <div class="text-3xl font-bold text-white" id="kpi-revenue">--</div>
                <div class="text-xs text-mau5-green mt-2">Aggregated Streams</div>
            </div>
            <div class="bg-mau5-panel border border-gray-800 rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <span class="text-4xl">‚ö°</span>
                </div>
                <h3 class="text-gray-500 text-xs font-mono uppercase mb-1">System Health</h3>
                <div class="text-3xl font-bold text-white" id="kpi-health">ONLINE</div>
                <div class="text-xs text-mau5-green mt-2">API Latency: <span id="api-latency">--</span>ms</div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Left Column: Charts -->
            <div class="lg:col-span-2 space-y-8">

                <!-- Revenue Chart -->
                <div class="bg-mau5-panel border border-gray-800 rounded-xl p-6">
                    <h3 class="text-white font-bold mb-6 flex items-center">
                        <span class="w-2 h-2 bg-mau5-green rounded-full mr-2"></span>
                        Revenue Distribution
                    </h3>
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- Artist Table -->
                <div class="bg-mau5-panel border border-gray-800 rounded-xl overflow-hidden">
                    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                        <h3 class="text-white font-bold">Roster Performance</h3>
                        <span class="text-xs text-gray-500 font-mono">LIVE FEED</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-black/50 text-xs uppercase font-mono text-gray-500">
                                <tr>
                                    <th class="px-6 py-3">Artist</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3 text-right">Listeners</th>
                                    <th class="px-6 py-3 text-right">Trend</th>
                                </tr>
                            </thead>
                            <tbody id="artist-table-body" class="divide-y divide-gray-800">
                                <!-- Populated via JS -->
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-gray-600 italic">Loading roster
                                        data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column: AI Terminal -->
            <div class="lg:col-span-1">
                <div class="sticky top-24">
                    <div
                        class="bg-[#0d1117] rounded-xl border border-gray-700 shadow-2xl overflow-hidden flex flex-col h-[600px]">
                        <!-- Terminal Header -->
                        <div class="bg-gray-800 px-4 py-3 flex items-center justify-between border-b border-gray-700">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            </div>
                            <span class="text-xs font-mono text-gray-400">grok-intelligence ‚Äî v3.0</span>
                        </div>

                        <!-- Terminal Output -->
                        <div id="terminal-output"
                            class="flex-grow p-4 font-mono text-xs md:text-sm overflow-y-auto space-y-4 text-gray-300">
                            <div class="text-mau5-green">Welcome to mau5trap intelligence.</div>
                            <div>System connected to secure backend.</div>
                            <div>Type a query below to analyze data.</div>
                            <div class="text-gray-500 italic">Example: "Who is my top performing artist this month?"
                            </div>
                            <hr class="border-gray-800 my-2">
                        </div>

                        <!-- Terminal Input -->
                        <div class="p-4 bg-black/50 border-t border-gray-700">
                            <form id="ai-form" class="flex items-center">
                                <span class="text-mau5-green mr-2 font-mono">‚ûú</span>
                                <input type="text" id="ai-input" autocomplete="off"
                                    class="flex-grow bg-transparent border-none outline-none text-white font-mono text-sm placeholder-gray-700"
                                    placeholder="Ask Grok a question...">
                            </form>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-mau5-panel border border-gray-800 rounded-xl">
                        <h4 class="text-xs font-mono text-gray-500 uppercase mb-2">Quick Actions</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="downloadReport()"
                                class="px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-xs text-white border border-gray-700 transition-colors">
                                üìÑ Download PDF
                            </button>
                            <button onclick="printReport()"
                                class="px-3 py-2 bg-gray-800 hover:bg-gray-700 rounded text-xs text-white border border-gray-700 transition-colors">
                                üñ®Ô∏è Auto-Print
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-gray-800 py-6 mt-12 bg-mau5-panel">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-xs text-gray-500 font-mono">
                CONNECTED TO: <span id="api-endpoint-display" class="text-gray-400">...</span>
            </p>
        </div>
    </footer>

    <!-- Logic -->
    <script>
        // --- 1. SETUP & STATE ---
        document.getElementById('user-display-name').innerText = userData.name || 'User';
        document.getElementById('api-endpoint-display').innerText = API_BASE;

        const statusIndicator = document.getElementById('status-indicator');
        let mainChart = null;

        // --- 2. LOGOUT FUNCTION ---
        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userData');

            // FIX: Handle logout in preview mode
            if (isPreview) {
                alert("Logged out. (Reloading preview...)");
                window.location.reload();
            } else {
                try {
                    window.location.href = 'login.html';
                } catch (e) {
                    console.error(e);
                }
            }
        }

        // --- 3. FETCH DATA (THE CORE LIVE FUNCTION) ---
        async function fetchData() {
            setLoading(true);
            const startTime = Date.now();

            try {
                let data;
                try {
                    // Try to fetch from real API first
                    // Note: In preview environment, localhost:3000 might not be reachable if not running locally
                    const res = await fetch(`${API_BASE}/label/overview`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    const latency = Date.now() - startTime;
                    document.getElementById('api-latency').innerText = latency;

                    if (res.ok) {
                        const overview = await res.json();

                        // Transform API /label/overview data to dashboard format
                        data = {
                            stats: {
                                totalArtists: overview.activeArtists,
                                revenue: `$${(overview.monthlyRevenue / 1000000).toFixed(1)}M`
                            },
                            revenueBreakdown: {
                                labels: overview.topArtists.map(a => a.name),
                                values: overview.topArtists.map(a => a.revenue)
                            },
                            artists: overview.topArtists.map(a => ({
                                name: a.name,
                                status: 'Active',
                                statusColor: 'emerald',
                                listeners: '--', // API doesn't return this in overview yet, or we need to fetch all artists
                                trend: a.roi
                            }))
                        };
                        setStatus(true);
                    } else {
                        throw new Error('API Error');
                    }
                } catch (e) {
                    // FALLBACK FOR DEMO / PREVIEW
                    // If we can't reach localhost, use simulation data immediately
                    console.warn("Backend not reachable (normal for Preview Mode). Using Simulation Data.");
                    data = getSimulationData();
                    setStatus(false);
                    document.getElementById('api-latency').innerText = "0";
                }

                updateUI(data);

            } catch (error) {
                console.error("Critical Error", error);
            } finally {
                setLoading(false);
            }
        }

        // --- 4. UI UPDATES ---
        function updateUI(data) {
            // Update KPIs
            document.getElementById('kpi-artists').innerText = data.stats.totalArtists;
            document.getElementById('kpi-revenue').innerText = data.stats.revenue;

            // Update Chart
            updateChart(data.revenueBreakdown);

            // Update Table
            const tbody = document.getElementById('artist-table-body');
            tbody.innerHTML = '';

            data.artists.forEach(artist => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-white/5 transition-colors cursor-pointer";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white">${artist.name}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-xs bg-${artist.statusColor}-900/30 text-${artist.statusColor}-400 border border-${artist.statusColor}-900">${artist.status}</span></td>
                    <td class="px-6 py-4 text-right font-mono">${artist.listeners || '--'}</td>
                    <td class="px-6 py-4 text-right text-${artist.trend > 0 ? 'mau5-green' : 'red-500'}">${artist.trend > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(artist.trend || 0)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateChart(data) {
            const ctx = document.getElementById('mainChart').getContext('2d');

            if (mainChart) mainChart.destroy();

            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Revenue (USD)',
                        data: data.values,
                        backgroundColor: '#00ff00', // mau5 green
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#333' },
                            ticks: { color: '#888' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#888' }
                        }
                    }
                }
            });
        }

        function setStatus(isOnline) {
            if (isOnline) {
                statusIndicator.classList.remove('bg-red-500', 'shadow-[0_0_10px_#ef4444]');
                statusIndicator.classList.add('bg-mau5-green', 'shadow-[0_0_10px_#00ff00]');
                document.getElementById('kpi-health').innerText = "ONLINE";
                document.getElementById('kpi-health').className = "text-3xl font-bold text-mau5-green glow-text";
            } else {
                statusIndicator.classList.add('bg-yellow-500', 'shadow-[0_0_10px_#eab308]');
                statusIndicator.classList.remove('bg-mau5-green', 'shadow-[0_0_10px_#00ff00]');
                document.getElementById('kpi-health').innerText = "SIMULATION";
                document.getElementById('kpi-health').className = "text-3xl font-bold text-yellow-500";

                // Add note to terminal if not already there
                if (!document.getElementById('sim-warning')) {
                    const div = document.createElement('div');
                    div.id = 'sim-warning';
                    div.className = 'text-yellow-500 mt-2';
                    div.innerText = "‚ö†Ô∏è Connection to backend failed. Showing simulation data.";
                    terminalOutput.appendChild(div);
                }
            }
        }

        function setLoading(isLoading) {
            // Optional: Add loading spinner logic
        }

        // --- 5. AI TERMINAL LOGIC ---
        const aiForm = document.getElementById('ai-form');
        const aiInput = document.getElementById('ai-input');
        const terminalOutput = document.getElementById('terminal-output');

        aiForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = aiInput.value.trim();
            if (!query) return;

            // 1. Add User query to UI
            addToTerminal(`user@mau5trap:~$ ${query}`, "text-white");
            aiInput.value = '';

            // 2. Send to API
            addToTerminal("[SYSTEM] Processing query...", "text-gray-500");

            try {
                const response = await fetch(`${API_BASE}/ai/analyze`, { // Calls your backend Grok endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ query })
                });

                if (response.ok) {
                    const data = await response.json();
                    addToTerminal(`[GROK] ${data.response || data.message}`, "text-mau5-green");
                } else {
                    // Fallback simulation if backend is down
                    setTimeout(() => {
                        addToTerminal("[GROK] (Simulated) Based on current trends, REZZ is outperforming projected tour revenue by 15% in the Midwest region.", "text-emerald-400");
                    }, 1000);
                }
            } catch (err) {
                setTimeout(() => {
                    addToTerminal("[GROK] (Simulated) Backend unreachable. Analysis: deadmau5 streaming numbers represent 45% of total label volume.", "text-emerald-400");
                }, 1000);
            }
        });

        function addToTerminal(text, className) {
            const div = document.createElement('div');
            div.className = className || 'text-gray-300';
            div.innerText = text;
            terminalOutput.appendChild(div);
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        // --- 6. ACTIONS ---
        async function downloadReport() {
            addToTerminal("[SYSTEM] Requesting PDF Report...", "text-gray-500");
            try {
                const res = await fetch(`${API_BASE}/exports?format=pdf&timeframe=30d`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const blob = await res.blob();
                    // Check if response is actually a PDF (API might return JSON err even with 200 sometimes, but usually 200 is good)
                    if (blob.type !== 'application/pdf') {
                        throw new Error('Received non-PDF response');
                    }

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "mau5trap_report.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    addToTerminal("[SUCCESS] Report downloaded.", "text-mau5-green");
                } else {
                    const err = await res.json();
                    addToTerminal(`[ERROR] ${err.error || 'Export failed'}`, "text-red-500");
                }
            } catch (e) {
                console.error(e);
                addToTerminal("[ERROR] Export failed.", "text-red-500");
            }
        }

        function printReport() {
            alert("Sending print job to local IP...");
            // Implementation would be similar, triggering a backend print job
        }

        // --- 7. MOCK DATA GENERATOR (Fallback) ---
        function getSimulationData() {
            return {
                stats: {
                    totalArtists: "36",
                    revenue: "$1.2M"
                },
                revenueBreakdown: {
                    labels: ['Streaming', 'Touring', 'Merch', 'Sync', 'Publishing'],
                    values: [450000, 320000, 150000, 80000, 200000]
                },
                artists: [
                    { name: 'deadmau5', status: 'Active', statusColor: 'emerald', listeners: '2.4M', trend: 12 },
                    { name: 'REZZ', status: 'Touring', statusColor: 'blue', listeners: '1.8M', trend: 8 },
                    { name: 'BlackGummy', status: 'Studio', statusColor: 'purple', listeners: '450K', trend: -2 },
                    { name: 'No Mana', status: 'Active', statusColor: 'emerald', listeners: '380K', trend: 5 }
                ]
            };
        }

        // Initialize
        fetchData();

    </script>
</body>

</html>